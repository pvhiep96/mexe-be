<% content_for(:title, "Chi ti·∫øt ƒë∆°n h√†ng") %>

<div class="admin-order-show">
  <div class="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1>ƒê∆°n h√†ng #<%= @order.order_number %></h1>
    <div>
      <%= link_to "‚Üê Quay l·∫°i danh s√°ch", admin_orders_path, class: "btn btn-secondary" %>
    </div>
  </div>

  <div class="order-details" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
    <!-- Order Information -->
    <div class="section" style="margin-bottom: 30px;">
      <h3>Th√¥ng tin ƒë∆°n h√†ng</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <strong>M√£ ƒë∆°n h√†ng:</strong> <%= @order.order_number %><br>
          <% if @order.user_order_info %>
            <strong>Kh√°ch h√†ng:</strong> <%= @order.user_order_info.buyer_name %><br>
            <strong>Email:</strong> <%= @order.user_order_info.buyer_email %><br>
            <strong>ƒêi·ªán tho·∫°i:</strong> <%= @order.user_order_info.buyer_phone %><br>
          <% else %>
            <strong>Kh√°ch h√†ng:</strong> <%= @order.user ? @order.user.email : @order.guest_email %><br>
            <% if @order.guest_name.present? %>
              <strong>T√™n:</strong> <%= @order.guest_name %><br>
            <% end %>
            <% if @order.guest_phone.present? %>
              <strong>ƒêi·ªán tho·∫°i:</strong> <%= @order.guest_phone %><br>
            <% end %>
          <% end %>
        </div>
        <div>
          <strong>T·ªïng ti·ªÅn:</strong> <%= number_to_currency(@order.total_amount, unit: "‚Ç´", precision: 0) %><br>
          <strong>Ng√†y ƒë·∫∑t:</strong> <%= @order.created_at.strftime("%d/%m/%Y %H:%M") %><br>
          <!-- Status Display -->
          <div style="margin-top: 15px;">
            <strong>Tr·∫°ng th√°i:</strong>
            <span class="badge badge-<%= @order.status == 'pending' ? 'warning' : @order.status == 'delivered' ? 'success' : 'info' %>">
              <%= @order.status.humanize %>
            </span><br>
            <strong>X·ª≠ l√Ω v·∫≠n chuy·ªÉn:</strong>
            <span class="badge badge-<%= @order.processing_not_processed? ? 'danger' : @order.processing_processing_delivered? ? 'success' : 'warning' %>">
              <%= @order.processing_status_text %>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Status Update Form -->
    <% if @can_update_status %>
      <div class="section" style="margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
        <h3 style="margin-top: 0; color: #007bff;">üìù C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng</h3>
        <%= form_with model: @order, url: admin_order_path(@order), method: :patch, local: true do |form| %>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
            <div>
              <%= form.label :status, "Tr·∫°ng th√°i ƒë∆°n h√†ng", style: "display: block; margin-bottom: 8px; font-weight: bold; color: #333;" %>
              <%= form.select :status,
                              options_for_select([
                                ['Ch·ªù x√°c nh·∫≠n', 'pending'],
                                ['ƒê√£ x√°c nh·∫≠n', 'confirmed'],
                                ['ƒêang x·ª≠ l√Ω', 'processing'],
                                ['ƒê√£ giao v·∫≠n chuy·ªÉn', 'shipped'],
                                ['ƒê√£ giao h√†ng', 'delivered'],
                                ['ƒê√£ h·ªßy', 'cancelled'],
                                ['ƒê√£ ho√†n ti·ªÅn', 'refunded']
                              ], @order.status),
                              {},
                              { style: "width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; background: white;" } %>
            </div>
            <div>
              <%= form.label :status_processed, "X·ª≠ l√Ω v·∫≠n chuy·ªÉn", style: "display: block; margin-bottom: 8px; font-weight: bold; color: #333;" %>
              <%= form.select :status_processed,
                              options_for_select([
                                ['Ch∆∞a x·ª≠ l√Ω', 'not_processed'],
                                ['ƒê√£ giao ƒë∆°n v·ªã v·∫≠n chuy·ªÉn', 'shipped_to_carrier'],
                                ['ƒê√£ giao h√†ng', 'processing_delivered']
                              ], @order.status_processed),
                              {},
                              { style: "width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; background: white;" } %>
            </div>
          </div>
          <%= form.submit "üíæ C·∫≠p nh·∫≠t tr·∫°ng th√°i",
                          class: "btn btn-primary",
                          style: "background: #007bff; border-color: #007bff; padding: 12px 24px; font-weight: bold; border-radius: 6px; font-size: 14px;" %>
        <% end %>
      </div>
    <% end %>

    <!-- Buyer Information (if available from user_order_info) -->
    <% if @order.user_order_info %>
      <div class="section" style="margin-bottom: 30px;">
        <h3>Th√¥ng tin ng∆∞·ªùi mua</h3>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <strong>T√™n ng∆∞·ªùi mua:</strong> <%= @order.user_order_info.buyer_name %><br>
              <strong>Email:</strong> <%= @order.user_order_info.buyer_email %><br>
              <strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <%= @order.user_order_info.buyer_phone %><br>
            </div>
            <div>
              <strong>ƒê·ªãa ch·ªâ:</strong> <%= @order.user_order_info.buyer_address %><br>
              <% if @order.user_order_info.buyer_city.present? %>
                <strong>Th√†nh ph·ªë:</strong> <%= @order.user_order_info.buyer_city %><br>
              <% end %>
            </div>
          </div>
          <% if @order.user_order_info.notes.present? %>
            <div style="margin-top: 10px;">
              <strong>Ghi ch√∫:</strong><br>
              <div style="margin-left: 10px; margin-top: 5px; font-style: italic;">
                <%= simple_format(@order.user_order_info.notes) %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Shipping Information -->
    <% if (@order.respond_to?(:shipping_provider) && @order.shipping_provider.present?) || (@order.respond_to?(:tracking_number) && @order.tracking_number.present?) %>
      <div class="section" style="margin-bottom: 30px;">
        <h3>Th√¥ng tin v·∫≠n chuy·ªÉn</h3>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
          <% if @order.respond_to?(:shipping_provider) && @order.shipping_provider.present? %>
            <strong>ƒê∆°n v·ªã v·∫≠n chuy·ªÉn:</strong>
            <% if @order.respond_to?(:shipping_provider_name) %>
              <%= @order.shipping_provider_name %>
            <% else %>
              <%= @order.shipping_provider %>
            <% end %><br>
          <% end %>
          <% if @order.respond_to?(:tracking_number) && @order.tracking_number.present? %>
            <strong>M√£ v·∫≠n ƒë∆°n:</strong> <%= @order.tracking_number %><br>
          <% end %>
          <% if @order.respond_to?(:full_tracking_url) && @order.full_tracking_url.present? %>
            <strong>Link theo d√µi:</strong>
            <a href="<%= @order.full_tracking_url %>" target="_blank" style="color: #007bff;">
              <%= @order.full_tracking_url %>
            </a><br>
          <% end %>
          <% if @order.respond_to?(:shipped_at) && @order.shipped_at.present? %>
            <strong>Th·ªùi gian giao v·∫≠n chuy·ªÉn:</strong> <%= @order.shipped_at.strftime("%d/%m/%Y %H:%M") %><br>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Update Shipping Form -->
    <% if @can_update_shipping %>
      <div class="section" style="margin-bottom: 30px;">
        <h3>C·∫≠p nh·∫≠t th√¥ng tin v·∫≠n chuy·ªÉn</h3>
        <%= form_with model: @order, url: update_shipping_admin_order_path(@order), method: :patch, local: true do |form| %>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
            <div>
              <%= form.label :shipping_provider, "ƒê∆°n v·ªã v·∫≠n chuy·ªÉn", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
              <%= form.select :shipping_provider,
                              options_for_select(Order::SHIPPING_PROVIDERS, @order.respond_to?(:shipping_provider) ? @order.shipping_provider : nil),
                              { prompt: 'Ch·ªçn ƒë∆°n v·ªã v·∫≠n chuy·ªÉn' },
                              { style: "width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" } %>
            </div>
            <div>
              <%= form.label :tracking_number, "M√£ v·∫≠n ƒë∆°n", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
              <%= form.text_field :tracking_number,
                                  value: @order.respond_to?(:tracking_number) ? @order.tracking_number : nil,
                                  placeholder: "Nh·∫≠p m√£ v·∫≠n ƒë∆°n",
                                  style: "width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" %>
            </div>
          </div>
          <div style="margin-bottom: 15px;">
            <%= form.label :tracking_url, "Link theo d√µi (t√πy ch·ªçn)", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
            <%= form.url_field :tracking_url,
                               placeholder: "https://...",
                               style: "width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" %>
            <small style="color: #666;">N·∫øu ƒë·ªÉ tr·ªëng, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o link theo d√µi d·ª±a tr√™n ƒë∆°n v·ªã v·∫≠n chuy·ªÉn</small>
          </div>

          <div style="margin-bottom: 15px;">
            <%= form.label :notes, "Ghi ch√∫", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
            <%= form.text_area :notes,
                               rows: 3,
                               placeholder: "Ghi ch√∫ v·ªÅ vi·ªác giao h√†ng...",
                               style: "width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" %>
          </div>

          <%= form.submit "C·∫≠p nh·∫≠t th√¥ng tin v·∫≠n chuy·ªÉn",
                          class: "btn btn-primary",
                          style: "background: #28a745; border-color: #28a745;" %>
        <% end %>
      </div>
    <% end %>

    <!-- Products -->
    <div class="section" style="margin-bottom: 30px;">
      <h3>S·∫£n ph·∫©m trong ƒë∆°n h√†ng</h3>
      <div style="background: white; border-radius: 4px; overflow: hidden; border: 1px solid #ddd;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f8f9fa;">
            <tr>
              <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">S·∫£n ph·∫©m</th>
              <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">SKU</th>
              <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">S·ªë l∆∞·ª£ng</th>
              <th style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;">ƒê∆°n gi√°</th>
              <th style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;">Th√†nh ti·ªÅn</th>
              <% if current_admin_user.super_admin? %>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Client</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @order.order_items.includes(:product).each do |item| %>
              <% if current_admin_user.super_admin? || item.product.client_id == current_admin_user.id %>
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #f8f9fa;">
                    <strong><%= item.product.name %></strong><br>
                    <small><%= item.product.brand&.name %></small>
                  </td>
                  <td style="padding: 12px; border-bottom: 1px solid #f8f9fa;"><%= item.product.sku %></td>
                  <td style="padding: 12px; border-bottom: 1px solid #f8f9fa; text-align: center;"><%= item.quantity %></td>
                  <td style="padding: 12px; border-bottom: 1px solid #f8f9fa; text-align: right;">
                    <%= number_to_currency(item.unit_price, unit: "‚Ç´", precision: 0) %>
                  </td>
                  <td style="padding: 12px; border-bottom: 1px solid #f8f9fa; text-align: right;">
                    <strong><%= number_to_currency(item.quantity * item.unit_price, unit: "‚Ç´", precision: 0) %></strong>
                  </td>
                  <% if current_admin_user.super_admin? %>
                    <td style="padding: 12px; border-bottom: 1px solid #f8f9fa;">
                      <%= item.product.client&.display_name || 'Kh√¥ng c√≥' %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Shipping Information -->
    <div class="section">
      <h3>Th√¥ng tin giao h√†ng</h3>
      <div style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div>
            <% if @order.shipping_name.present? %>
              <strong>Ng∆∞·ªùi nh·∫≠n:</strong> <%= @order.shipping_name %><br>
            <% elsif @order.guest_name.present? %>
              <strong>Ng∆∞·ªùi nh·∫≠n:</strong> <%= @order.guest_name %><br>
            <% elsif @order.user.present? %>
              <strong>Ng∆∞·ªùi nh·∫≠n:</strong> <%= @order.user.full_name || @order.user.email %><br>
            <% end %>
            <% if @order.shipping_phone.present? %>
              <strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <%= @order.shipping_phone %><br>
            <% elsif @order.guest_phone.present? %>
              <strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <%= @order.guest_phone %><br>
            <% elsif @order.user&.phone.present? %>
              <strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <%= @order.user.phone %><br>
            <% end %>
            <% if @order.delivery_type == 'store_pickup' %>
              <strong>H√¨nh th·ª©c:</strong> Nh·∫≠n t·∫°i c·ª≠a h√†ng<br>
              <% if @order.store_location.present? %>
                <strong>C·ª≠a h√†ng:</strong> <%= @order.store_location %><br>
              <% end %>
            <% else %>
              <strong>H√¨nh th·ª©c:</strong> Giao h√†ng t·∫≠n n∆°i<br>
            <% end %>
          </div>
          <div>
            <% if @order.delivery_type == 'home' && (@order.delivery_address.present? || @order.shipping_city.present?) %>
              <strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong><br>
              <div style="margin-left: 10px; margin-top: 5px;">
                <% if @order.delivery_address.present? %>
                  <%= @order.delivery_address %><br>
                <% end %>
                <% address_parts = [] %>
                <% address_parts << @order.shipping_ward if @order.shipping_ward.present? %>
                <% address_parts << @order.shipping_district if @order.shipping_district.present? %>
                <% address_parts << @order.shipping_city if @order.shipping_city.present? %>
                <% if address_parts.any? %>
                  <%= address_parts.join(', ') %><br>
                <% end %>
                <% if @order.shipping_postal_code.present? %>
                  <strong>M√£ b∆∞u ƒëi·ªán:</strong> <%= @order.shipping_postal_code %><br>
                <% end %>
              </div>
            <% end %>
            <% if @order.notes.present? %>
              <strong>Ghi ch√∫:</strong><br>
              <div style="margin-left: 10px; margin-top: 5px; font-style: italic;">
                <%= simple_format(@order.notes) %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
  }
  .badge-success { background: #28a745; color: white; }
  .badge-danger { background: #dc3545; color: white; }
  .badge-warning { background: #ffc107; color: black; }
  .badge-info { background: #17a2b8; color: white; }
  .badge-primary { background: #007bff; color: white; }
  .btn {
    display: inline-block;
    padding: 8px 16px;
    margin: 2px;
    background: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    border: 1px solid #007bff;
    cursor: pointer;
  }
  .btn:hover {
    background: #0056b3;
    border-color: #0056b3;
  }
  .btn-primary {
    background: #007bff;
    border-color: #007bff;
  }
  .btn-secondary {
    background: #6c757d;
    border-color: #6c757d;
  }
</style>