<% content_for(:title, "Chi tiết đơn hàng") %>

<div class="admin-order-show">
  <div class="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1>Đơn hàng #<%= @order.order_number %></h1>
    <div>
      <%= link_to "← Quay lại danh sách", admin_orders_path, class: "btn btn-secondary" %>
    </div>
  </div>

  <div class="order-details" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 20px;">

    <!-- Order Information -->
    <div class="section" style="margin-bottom: 30px;">
      <h3>Thông tin đơn hàng</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <strong>Mã đơn hàng:</strong> <%= @order.order_number %><br>
          <% if @order.user_order_info %>
            <strong>Khách hàng:</strong> <%= @order.user_order_info.buyer_name %><br>
            <strong>Email:</strong> <%= @order.user_order_info.buyer_email %><br>
            <strong>Điện thoại:</strong> <%= @order.user_order_info.buyer_phone %><br>
          <% else %>
            <strong>Khách hàng:</strong> <%= @order.user ? @order.user.email : @order.guest_email %><br>
            <% if @order.guest_name.present? %>
              <strong>Tên:</strong> <%= @order.guest_name %><br>
            <% end %>
            <% if @order.guest_phone.present? %>
              <strong>Điện thoại:</strong> <%= @order.guest_phone %><br>
            <% end %>
          <% end %>
        </div>
        <div>
          <strong>Trạng thái:</strong>
          <span class="badge badge-<%= @order.status == 'pending' ? 'warning' : @order.status == 'delivered' ? 'success' : 'info' %>"
               id="openModal"
          >
            <%= @order.status.humanize %>
          </span><br>

          <strong>Xử lý vận chuyển:</strong>
          <span
            class="badge badge-<%= @order.processing_not_processed? ? 'danger' : @order.processing_processing_delivered? ? 'success' : 'warning' %>"
              id="openModalPrcessing"
          >
            <%= @order.processing_status_text %>
          </span><br>

          <strong>Tổng tiền:</strong> <%= number_to_currency(@order.total_amount, unit: "₫", precision: 0) %><br>
          <strong>Ngày đặt:</strong> <%= @order.created_at.strftime("%d/%m/%Y %H:%M") %>
        </div>
      </div>
    </div>

    <!-- Buyer Information (if available from user_order_info) -->
    <% if @order.user_order_info %>
      <div class="section" style="margin-bottom: 30px;">
        <h3>Thông tin người mua</h3>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <strong>Tên người mua:</strong> <%= @order.user_order_info.buyer_name %><br>
              <strong>Email:</strong> <%= @order.user_order_info.buyer_email %><br>
              <strong>Số điện thoại:</strong> <%= @order.user_order_info.buyer_phone %><br>
            </div>
            <div>
              <strong>Địa chỉ:</strong> <%= @order.user_order_info.buyer_address %><br>
              <% if @order.user_order_info.buyer_city.present? %>
                <strong>Thành phố:</strong> <%= @order.user_order_info.buyer_city %><br>
              <% end %>
            </div>
          </div>
          <% if @order.user_order_info.notes.present? %>
            <div style="margin-top: 10px;">
              <strong>Ghi chú:</strong><br>
              <div style="margin-left: 10px; margin-top: 5px; font-style: italic;">
                <%= simple_format(@order.user_order_info.notes) %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Shipping Information -->
    <% if (@order.respond_to?(:shipping_provider) && @order.shipping_provider.present?) || (@order.respond_to?(:tracking_number) && @order.tracking_number.present?) %>
      <div class="section" style="margin-bottom: 30px;">
        <h3>Thông tin vận chuyển</h3>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
          <% if @order.respond_to?(:shipping_provider) && @order.shipping_provider.present? %>
            <strong>Đơn vị vận chuyển:</strong>
            <% if @order.respond_to?(:shipping_provider_name) %>
              <%= @order.shipping_provider_name %>
            <% else %>
              <%= @order.shipping_provider %>
            <% end %><br>
          <% end %>
          <% if @order.respond_to?(:tracking_number) && @order.tracking_number.present? %>
            <strong>Mã vận đơn:</strong> <%= @order.tracking_number %><br>
          <% end %>
          <% if @order.respond_to?(:full_tracking_url) && @order.full_tracking_url.present? %>
            <strong>Link theo dõi:</strong>
            <a href="<%= @order.full_tracking_url %>" target="_blank" style="color: #007bff;">
              <%= @order.full_tracking_url %>
            </a><br>
          <% end %>
          <% if @order.respond_to?(:shipped_at) && @order.shipped_at.present? %>
            <strong>Thời gian giao vận chuyển:</strong> <%= @order.shipped_at.strftime("%d/%m/%Y %H:%M") %><br>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Update Shipping Form -->
    <% if @can_update_shipping %>
      <div class="section" style="margin-bottom: 30px;">
        <h3>Cập nhật thông tin vận chuyển</h3>
        <%= form_with model: @order, url: update_shipping_admin_order_path(@order), method: :patch, local: true do |form| %>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
            <div>
              <%= form.label :shipping_provider, "Đơn vị vận chuyển", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
              <%= form.select :shipping_provider,
                              options_for_select(Order::SHIPPING_PROVIDERS, @order.respond_to?(:shipping_provider) ? @order.shipping_provider : nil),
                              { prompt: 'Chọn đơn vị vận chuyển' },
                              { style: "width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" } %>
            </div>
            <div>
              <%= form.label :tracking_number, "Mã vận đơn", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
              <%= form.text_field :tracking_number,
                                  value: @order.respond_to?(:tracking_number) ? @order.tracking_number : nil,
                                  placeholder: "Nhập mã vận đơn",
                                  style: "width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" %>
            </div>
          </div>

          <div style="margin-bottom: 15px;">
            <%= form.label :tracking_url, "Link theo dõi (tùy chọn)", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
            <%= form.url_field :tracking_url,
                                value: @order.respond_to?(:tracking_url) ? @order.tracking_url : nil,
                               placeholder: "https://...",
                               style: "width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;", disabled: true %>
            <small style="color: #666;">Nếu để trống, hệ thống sẽ tự động tạo link theo dõi dựa trên đơn vị vận chuyển</small>
          </div>

          <div style="margin-bottom: 15px;">
            <%= form.label :notes, "Ghi chú", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
            <%= form.text_area :notes,
                               rows: 3,
                               placeholder: "Ghi chú về việc giao hàng...",
                               style: "width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" %>
          </div>

          <%= form.submit "Cập nhật thông tin vận chuyển",
                          class: "btn btn-primary",
                          style: "background: #28a745; border-color: #28a745;" %>
        <% end %>
      </div>
    <% end %>

    <!-- Products -->
    <div class="section" style="margin-bottom: 30px;">
      <h3>Sản phẩm trong đơn hàng</h3>
      <div style="background: white; border-radius: 4px; overflow: hidden; border: 1px solid #ddd;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f8f9fa;">
            <tr>
              <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Sản phẩm</th>
              <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">SKU</th>
              <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">Số lượng</th>
              <th style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;">Đơn giá</th>
              <th style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;">Thành tiền</th>
              <% if current_admin_user.super_admin? %>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Client</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @order.order_items.includes(:product).each do |item| %>
              <% if current_admin_user.super_admin? || item.product.client_id == current_admin_user.id %>
                <% variant_info = item.variant_info.is_a?(Hash) ? item.variant_info : (JSON.parse(item.variant_info) rescue nil) %>
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #f8f9fa;">
                    <strong><%= item.product.name %></strong><br>
                    <% if variant_info %>
                      <span style="display: inline-block; background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-top: 4px;">
                        <%= variant_info['variant_name'] %>: <%= variant_info['variant_value'] %>
                        <% if variant_info['variant_sku'] %>
                          (<%= variant_info['variant_sku'] %>)
                        <% end %>
                      </span><br>
                    <% end %>
                    <small><%= item.product.brand&.name %></small>
                  </td>
                  <td style="padding: 12px; border-bottom: 1px solid #f8f9fa;">
                    <%= variant_info ? variant_info['variant_sku'] : item.product.sku %>
                  </td>
                  <td style="padding: 12px; border-bottom: 1px solid #f8f9fa; text-align: center;"><%= item.quantity %></td>
                  <td style="padding: 12px; border-bottom: 1px solid #f8f9fa; text-align: right;">
                    <%= number_to_currency(item.unit_price, unit: "₫", precision: 0) %>
                    <% if variant_info && variant_info['price_adjustment'] %>
                      <% price_adj = variant_info['price_adjustment'].to_f %>
                      <% if price_adj != 0 %>
                        <br>
                        <small style="color: <%= price_adj > 0 ? '#d32f2f' : '#388e3c' %>;">
                          (<%= price_adj > 0 ? '+' : '' %><%= number_to_currency(price_adj, unit: "₫", precision: 0) %>)
                        </small>
                      <% end %>
                    <% end %>
                  </td>
                  <td style="padding: 12px; border-bottom: 1px solid #f8f9fa; text-align: right;">
                    <strong><%= number_to_currency(item.quantity * item.unit_price, unit: "₫", precision: 0) %></strong>
                  </td>
                  <% if current_admin_user.super_admin? %>
                    <td style="padding: 12px; border-bottom: 1px solid #f8f9fa;">
                      <%= item.product.client&.display_name || 'Không có' %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Order Summary -->
      <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
        <div style="max-width: 400px; margin-left: auto;">
          <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
            <span>Tổng tiền hàng:</span>
            <strong><%= number_to_currency(@order.subtotal, unit: "₫", precision: 0) %></strong>
          </div>
          <% if @order.discount_amount && @order.discount_amount > 0 %>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6; color: #dc3545;">
              <span>Giảm giá:</span>
              <strong>-<%= number_to_currency(@order.discount_amount, unit: "₫", precision: 0) %></strong>
            </div>
          <% end %>
          <% if @order.shipping_fee && @order.shipping_fee > 0 %>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
              <span>Phí vận chuyển:</span>
              <strong><%= number_to_currency(@order.shipping_fee, unit: "₫", precision: 0) %></strong>
            </div>
          <% end %>
          <% if @order.tax_amount && @order.tax_amount > 0 %>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
              <span>Thuế:</span>
              <strong><%= number_to_currency(@order.tax_amount, unit: "₫", precision: 0) %></strong>
            </div>
          <% end %>
          <div style="display: flex; justify-content: space-between; padding: 12px 0; font-size: 18px; border-top: 2px solid #007bff; margin-top: 8px;">
            <span><strong>Tổng đơn hàng:</strong></span>
            <strong style="color: #007bff;"><%= number_to_currency(@order.total_amount, unit: "₫", precision: 0) %></strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Shipping Information -->
    <div class="section">
      <h3>Thông tin giao hàng</h3>
      <div style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div>
            <% if @order.shipping_name.present? %>
              <strong>Người nhận:</strong> <%= @order.shipping_name %><br>
            <% elsif @order.guest_name.present? %>
              <strong>Người nhận:</strong> <%= @order.guest_name %><br>
            <% elsif @order.user.present? %>
              <strong>Người nhận:</strong> <%= @order.user.full_name || @order.user.email %><br>
            <% end %>

            <% if @order.shipping_phone.present? %>
              <strong>Số điện thoại:</strong> <%= @order.shipping_phone %><br>
            <% elsif @order.guest_phone.present? %>
              <strong>Số điện thoại:</strong> <%= @order.guest_phone %><br>
            <% elsif @order.user&.phone.present? %>
              <strong>Số điện thoại:</strong> <%= @order.user.phone %><br>
            <% end %>

            <% if @order.delivery_type == 'store_pickup' %>
              <strong>Hình thức:</strong> Nhận tại cửa hàng<br>
              <% if @order.store_location.present? %>
                <strong>Cửa hàng:</strong> <%= @order.store_location %><br>
              <% end %>
            <% else %>
              <strong>Hình thức:</strong> Giao hàng tận nơi<br>
            <% end %>
          </div>

          <div>
            <% if @order.delivery_type == 'home' && (@order.delivery_address.present? || @order.shipping_city.present?) %>
              <strong>Địa chỉ giao hàng:</strong><br>
              <div style="margin-left: 10px; margin-top: 5px;">
                <% if @order.delivery_address.present? %>
                  <%= @order.delivery_address %><br>
                <% end %>

                <% address_parts = [] %>
                <% address_parts << @order.shipping_ward if @order.shipping_ward.present? %>
                <% address_parts << @order.shipping_district if @order.shipping_district.present? %>
                <% address_parts << @order.shipping_city if @order.shipping_city.present? %>

                <% if address_parts.any? %>
                  <%= address_parts.join(', ') %><br>
                <% end %>

                <% if @order.shipping_postal_code.present? %>
                  <strong>Mã bưu điện:</strong> <%= @order.shipping_postal_code %><br>
                <% end %>
              </div>
            <% end %>

            <% if @order.notes.present? %>
              <strong>Ghi chú:</strong><br>
              <div style="margin-left: 10px; margin-top: 5px; font-style: italic;">
                <%= simple_format(@order.notes) %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
  }

  .badge-success { background: #28a745; color: white; }
  .badge-danger { background: #dc3545; color: white; }
  .badge-warning { background: #ffc107; color: black; }
  .badge-info { background: #17a2b8; color: white; }
  .badge-primary { background: #007bff; color: white; }

  .btn {
    display: inline-block;
    padding: 8px 16px;
    margin: 2px;
    background: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    border: 1px solid #007bff;
    cursor: pointer;
  }

  .btn:hover {
    background: #0056b3;
    border-color: #0056b3;
  }

  .btn-primary {
    background: #007bff;
    border-color: #007bff;
  }

  .btn-secondary {
    background: #6c757d;
    border-color: #6c757d;
  }
</style>

<!-- Modal -->
<div class="modal" id="changeStatusModal">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Change Order Status</h5>
      <button type="button" class="close" id="closeModal">&times;</button>
    </div>
    <div class="modal-body">
      <%= form_with model: @order, url: admin_order_path(@order), method: :patch, local: true do |form| %>
        <div class="form-group">
          <%= form.label :status, "Select New Status" %>
          <%= form.select :status, options_for_select(Order.statuses, @order.status), {}, class: "width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="closeModalFooter">Cancel</button>
          <%= form.submit "Change Status", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<div class="modal" id="changeStatusModalProcess">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Change Order Status</h5>
      <button type="button" class="close" id="closeModalProcess">&times;</button>
    </div>
    <div class="modal-body">
      <%= form_with model: @order, url: admin_order_path(@order), method: :patch, local: true do |form| %>
        <div class="form-group">
          <%= form.label :status_processed, "Chuyển trạng thái" %>
          <%= form.select :status_processed, options_for_select([['Chưa xử lý', 'not_processed' ], ['Đã giao đơn vị vận chuyển', 'shipped_to_carrier'], ['Đã giao hàng', 'processing_delivered']], @order.status_processed), {}, class: "form-control"  %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="closeModalFooterProcess">Cancel</button>
          <%= form.submit "Change Status", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
  /* Modal styles */
  .modal {
    display: none; /* Hidden by default */
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5); /* Black background with opacity */
  }

  .modal-content {
    background-color: #fff;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 50%;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  .modal-header,
  .modal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h5 {
    margin: 0;
  }

  .close {
    cursor: pointer;
    font-size: 1.5rem;
    border: none;
    background: none;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .btn-primary {
    background: #007bff;
    color: #fff;
  }

  .btn-secondary {
    background: #6c757d;
    color: #fff;
  }

  .btn:hover {
    opacity: 0.9;
  }
  .form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #fff;
    font-size: 16px;
    color: #333;
    appearance: none; /* Remove default browser styles */
    -webkit-appearance: none; /* For Safari */
    -moz-appearance: none; /* For Firefox */
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns%3D%22http%3A//www.w3.org/2000/svg%22 width%3D%2210%22 height%3D%225%22 viewBox%3D%220 0 10 5%22%3E%3Cpath fill%3D%22%23333%22 d%3D%22M0 0l5 5 5-5z%22/%3E%3C/svg%3E');
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 10px 5px;
  }

  .form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
  }

  /* Add padding to the dropdown container */
  .form-group {
    margin-bottom: 20px;
  }
</style>


<script>
  // JavaScript to handle modal open/close
  document.addEventListener('DOMContentLoaded', () => {
    const openModal = document.getElementById('openModal');
    const closeModal = document.getElementById('closeModal');
    const closeModalFooter = document.getElementById('closeModalFooter');
    const modal = document.getElementById('changeStatusModal');

    // Open modal
    openModal.addEventListener('click', () => {
      modal.style.display = 'block';
    });

    // Close modal
    closeModal.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    closeModalFooter.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    // Close modal when clicking outside the modal content
    window.addEventListener('click', (event) => {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });
  });

  document.addEventListener('DOMContentLoaded', () => {
    const openModal = document.getElementById('openModalPrcessing');
    const closeModal = document.getElementById('closeModalProcess');
    const closeModalFooter = document.getElementById('closeModalFooterProcess');
    const modal = document.getElementById('changeStatusModalProcess');

    // Open modal
    openModal.addEventListener('click', () => {
      modal.style.display = 'block';
    });

    // Close modal
    closeModal.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    closeModalFooter.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    // Close modal when clicking outside the modal content
    window.addEventListener('click', (event) => {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });
  });
</script>
