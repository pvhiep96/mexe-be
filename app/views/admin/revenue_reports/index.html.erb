<% content_for :title, "Báo cáo Doanh thu & Lợi nhuận" %>

<div class="revenue-reports-container">
  <div class="revenue-reports-header">
    <h1>Báo cáo Doanh thu & Lợi nhuận</h1>
    
    <!-- Filter Form -->
    <div class="filter-form">
      <%= form_with url: admin_revenue_reports_path, method: :get, local: true, class: "filter-form-inline" do |form| %>
        <div class="filter-group">
          <%= form.label :period, "Kỳ báo cáo:", class: "filter-label" %>
          <%= form.select :period, 
              options_for_select([
                ['Hàng ngày', 'daily'],
                ['Hàng tháng', 'monthly'],
                ['Hàng năm', 'yearly']
              ], @period), 
              {}, 
              { class: "filter-select" } %>
        </div>

        <% if @current_admin_user.super_admin? %>
          <div class="filter-group">
            <%= form.label :client_id, "Client:", class: "filter-label" %>
            <%= form.select :client_id, 
                options_from_collection_for_select(@clients, :id, :display_name, @client_id),
                { prompt: "Tất cả clients" }, 
                { class: "filter-select" } %>
          </div>
        <% end %>

        <div class="filter-group">
          <%= form.label :start_date, "Từ ngày:", class: "filter-label" %>
          <%= form.date_field :start_date, value: @start_date, class: "filter-input" %>
        </div>

        <div class="filter-group">
          <%= form.label :end_date, "Đến ngày:", class: "filter-label" %>
          <%= form.date_field :end_date, value: @end_date, class: "filter-input" %>
        </div>

        <div class="filter-group">
          <%= form.submit "Lọc", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card">
      <div class="summary-card-header">
        <h3>Tổng doanh thu</h3>
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="summary-card-value">
        <%= number_to_currency(@summary[:total_revenue], unit: "₫", precision: 0) %>
      </div>
    </div>

    <div class="summary-card">
      <div class="summary-card-header">
        <h3>Tổng lợi nhuận</h3>
        <i class="fas fa-coins"></i>
      </div>
      <div class="summary-card-value">
        <%= number_to_currency(@summary[:total_profit], unit: "₫", precision: 0) %>
      </div>
    </div>

    <div class="summary-card">
      <div class="summary-card-header">
        <h3>Tổng đơn hàng</h3>
        <i class="fas fa-shopping-cart"></i>
      </div>
      <div class="summary-card-value">
        <%= @summary[:total_orders] %>
      </div>
    </div>

    <div class="summary-card">
      <div class="summary-card-header">
        <h3>Sản phẩm bán</h3>
        <i class="fas fa-box"></i>
      </div>
      <div class="summary-card-value">
        <%= @summary[:total_products_sold] %>
      </div>
    </div>

    <div class="summary-card">
      <div class="summary-card-header">
        <h3>Giá trị đơn hàng TB</h3>
        <i class="fas fa-calculator"></i>
      </div>
      <div class="summary-card-value">
        <%= number_to_currency(@summary[:average_order_value], unit: "₫", precision: 0) %>
      </div>
    </div>

    <div class="summary-card">
      <div class="summary-card-header">
        <h3>Tỷ lệ lợi nhuận</h3>
        <i class="fas fa-percentage"></i>
      </div>
      <div class="summary-card-value">
        <%= number_to_percentage(@summary[:average_profit_margin], precision: 1) %>
      </div>
    </div>
  </div>

  <!-- Reports Table -->
  <div class="reports-table-container">
    <div class="table-header">
      <h2>Chi tiết báo cáo</h2>
      <div class="table-actions">
        <%= link_to "Xuất Excel", admin_revenue_reports_path(format: :xlsx, **request.query_parameters), class: "btn btn-info" %>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Ngày</th>
            <% if @current_admin_user.super_admin? %>
              <th>Client</th>
            <% end %>
            <th>Doanh thu</th>
            <th>Lợi nhuận</th>
            <th>Số đơn hàng</th>
            <th>Sản phẩm bán</th>
            <th>Giá trị đơn TB</th>
            <th>Tỷ lệ lợi nhuận</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody>
          <% if @reports.any? %>
            <% @reports.each do |report| %>
              <tr>
                <td>
                  <%= case @period
                  when 'daily'
                    report.report_date.strftime('%d/%m/%Y')
                  when 'monthly'
                    report.report_date.strftime('%m/%Y')
                  when 'yearly'
                    report.report_date.strftime('%Y')
                  end %>
                </td>
                <% if @current_admin_user.super_admin? %>
                  <td>
                    <%= link_to report.client&.display_name || 'N/A', 
                        admin_revenue_reports_path(client_id: report.client_id),
                        class: "client-link" %>
                  </td>
                <% end %>
                <td class="text-end">
                  <%= number_to_currency(report.total_revenue, unit: "₫", precision: 0) %>
                </td>
                <td class="text-end">
                  <%= number_to_currency(report.total_profit, unit: "₫", precision: 0) %>
                </td>
                <td class="text-center">
                  <%= report.order_count %>
                </td>
                <td class="text-center">
                  <%= report.product_count %>
                </td>
                <td class="text-end">
                  <%= number_to_currency(report.average_order_value, unit: "₫", precision: 0) %>
                </td>
                <td class="text-center">
                  <span class="profit-margin <%= report.profit_margin > 20 ? 'high' : report.profit_margin > 10 ? 'medium' : 'low' %>">
                    <%= number_to_percentage(report.profit_margin, precision: 1) %>
                  </span>
                </td>
                <td>
                  <%= link_to "Xem", admin_revenue_report_path(report), class: "btn btn-sm btn-outline-primary" %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="<%= @current_admin_user.super_admin? ? 9 : 8 %>" class="text-center text-muted">
                Không có dữ liệu báo cáo
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <h3>Thao tác nhanh</h3>
    <div class="action-buttons">
      <%= link_to "Báo cáo xu hướng", trends_admin_revenue_reports_path, class: "btn btn-outline-info" %>
      <% if @current_admin_user.super_admin? %>
        <%= link_to "Top clients", top_clients_admin_revenue_reports_path, class: "btn btn-outline-warning" %>
      <% end %>
      <%= link_to "Tạo báo cáo hôm nay", 
          generate_admin_revenue_reports_path(period: 'daily', date: Date.current), 
          method: :post, 
          class: "btn btn-outline-success" %>
    </div>
  </div>
</div>

<style>
.revenue-reports-container {
  padding: 20px;
}

.revenue-reports-header {
  margin-bottom: 30px;
}

.revenue-reports-header h1 {
  color: #2c3e50;
  margin-bottom: 20px;
}

.filter-form {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.filter-form-inline {
  display: flex;
  gap: 15px;
  align-items: end;
  flex-wrap: wrap;
}

.filter-group {
  display: flex;
  flex-direction: column;
  min-width: 150px;
}

.filter-label {
  font-weight: 600;
  margin-bottom: 5px;
  color: #495057;
}

.filter-select, .filter-input {
  padding: 8px 12px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 14px;
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.summary-card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border-left: 4px solid #007bff;
}

.summary-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.summary-card-header h3 {
  margin: 0;
  font-size: 14px;
  color: #6c757d;
  font-weight: 600;
}

.summary-card-header i {
  color: #007bff;
  font-size: 18px;
}

.summary-card-value {
  font-size: 24px;
  font-weight: bold;
  color: #2c3e50;
}

.reports-table-container {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 30px;
}

.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #dee2e6;
}

.table-header h2 {
  margin: 0;
  color: #2c3e50;
}

.table-actions {
  display: flex;
  gap: 10px;
}

.table th {
  background-color: #f8f9fa;
  font-weight: 600;
  color: #495057;
  border-top: none;
}

.profit-margin.high {
  color: #28a745;
  font-weight: bold;
}

.profit-margin.medium {
  color: #ffc107;
  font-weight: bold;
}

.profit-margin.low {
  color: #dc3545;
  font-weight: bold;
}

.client-link {
  color: #007bff;
  text-decoration: none;
}

.client-link:hover {
  text-decoration: underline;
}

.quick-actions {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
}

.quick-actions h3 {
  margin-bottom: 15px;
  color: #2c3e50;
}

.action-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

@media (max-width: 768px) {
  .filter-form-inline {
    flex-direction: column;
    align-items: stretch;
  }
  
  .filter-group {
    min-width: auto;
  }
  
  .summary-cards {
    grid-template-columns: 1fr;
  }
  
  .table-header {
    flex-direction: column;
    gap: 15px;
    align-items: stretch;
  }
  
  .action-buttons {
    flex-direction: column;
  }
}
</style>

