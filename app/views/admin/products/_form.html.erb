<% content_for(:title, "T·∫°o S·∫£n Ph·∫©m M·ªõi") %>

<%= form_with(model: [:admin, page.resource], local: true, multipart: true) do |form| %>
  <%= render "admin/application/form_errors", resource: page.resource %>
  
  <!-- Standard Product Fields -->
  <div class="field-unit">
    <%= form.label :name %>
    <%= form.text_field :name, class: "text-field" %>
  </div>
  
  <!-- Two-column layout for short fields -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <div class="field-unit">
      <%= form.label :slug %>
      <%= form.text_field :slug, class: "text-field" %>
    </div>
    
    <div class="field-unit">
      <%= form.label :sku %>
      <%= form.text_field :sku, class: "text-field" %>
    </div>
  </div>
  
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <div class="field-unit">
      <%= form.label :brand_id %>
      <%= form.collection_select :brand_id, Brand.all, :id, :name, { prompt: "Select a brand" }, class: "select" %>
    </div>
    
    <div class="field-unit">
      <%= form.label :category_id %>
      <%= form.collection_select :category_id, Category.all, :id, :name, { prompt: "Select a category" }, class: "select" %>
    </div>
  </div>
  
  <div class="field-unit">
    <%= form.label :short_description %>
    <%= form.text_area :short_description, rows: 3, class: "text-field" %>
  </div>
  
  <div class="field-unit">
    <%= form.label :description %>
    <%= form.text_area :description, rows: 5, class: "text-field" %>
  </div>
  
  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
    <div class="field-unit">
      <%= form.label :original_price %>
      <%= form.number_field :original_price, step: 0.01, class: "text-field" %>
    </div>
    
    <div class="field-unit">
      <%= form.label :price %>
      <%= form.number_field :price, step: 0.01, class: "text-field" %>
    </div>
    
    <div class="field-unit">
      <%= form.label :stock_quantity %>
      <%= form.number_field :stock_quantity, class: "text-field" %>
    </div>
    
    <div class="field-unit">
      <%= form.label :warranty_period %>
      <%= form.text_field :warranty_period, class: "text-field" %>
    </div>
  </div>
  
  <div class="field-unit" style="margin-bottom: 20px;">
    <div style="display: flex; align-items: center; gap: 12px;">
      <div class="toggle">
        <% if current_admin_user&.super_admin? %>
          <%= form.check_box :is_active, { class: "toggle-input", id: "product_is_active" } %>
        <% else %>
          <%= form.check_box :is_active, { class: "toggle-input", id: "product_is_active", disabled: true } %>
        <% end %>
        <label for="product_is_active" class="toggle-label <%= 'disabled' unless current_admin_user&.super_admin? %>">
          <span class="toggle-knob"></span>
        </label>
      </div>
      <div>
        <div id="active-label" style="font-weight: 700; color: #1f2937;">
          Hi·ªÉn th·ªã s·∫£n ph·∫©m tr√™n website
          <% unless current_admin_user&.super_admin? %>
            <span style="color: #dc3545; font-size: 12px; margin-left: 8px;">(Ch·ªâ Super Admin m·ªõi c√≥ quy·ªÅn ch·ªânh s·ª≠a)</span>
          <% end %>
        </div>
        <div style="font-size: 12px; color: #6b7280;">
          B·∫≠t ƒë·ªÉ s·∫£n ph·∫©m ƒë∆∞·ª£c ph√©p xu·∫•t hi·ªán tr√™n trang b√°n h√†ng. T·∫Øt ƒë·ªÉ ·∫©n s·∫£n ph·∫©m kh·ªèi website.
        </div>
      </div>
    </div>
  </div>
  
  <!-- Product Status Flags Section -->
  <div class="field-unit">
    <div class="field-unit__label">
      <label style="font-weight: bold;">üè∑Ô∏è Product Status Flags</label>
    </div>
    <div class="field-unit__field" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <% if current_admin_user&.super_admin? %>
          <%= form.check_box :is_essential_accessories %>
        <% else %>
          <%= form.check_box :is_essential_accessories, { disabled: true } %>
        <% end %>
        <%= form.label :is_essential_accessories, "üîß Essential Accessories (Ph·ª• ki·ªán thi·∫øt y·∫øu)", class: "status-flag-label #{'disabled' unless current_admin_user&.super_admin?}" %>
      </div>
      
      <div style="display: flex; align-items: center; gap: 8px;">
        <% if current_admin_user&.super_admin? %>
          <%= form.check_box :is_best_seller %>
        <% else %>
          <%= form.check_box :is_best_seller, { disabled: true } %>
        <% end %>
        <%= form.label :is_best_seller, "üèÜ Best Seller (B√°n ch·∫°y nh·∫•t)", class: "status-flag-label #{'disabled' unless current_admin_user&.super_admin?}" %>
      </div>
      
      <div style="display: flex; align-items: center; gap: 8px;">
        <% if current_admin_user&.super_admin? %>
          <%= form.check_box :is_new %>
        <% else %>
          <%= form.check_box :is_new, { disabled: true } %>
        <% end %>
        <%= form.label :is_new, "üÜï New (M·ªõi)", class: "status-flag-label #{'disabled' unless current_admin_user&.super_admin?}" %>
      </div>
      
      <div style="display: flex; align-items: center; gap: 8px;">
        <% if current_admin_user&.super_admin? %>
          <%= form.check_box :is_hot %>
        <% else %>
          <%= form.check_box :is_hot, { disabled: true } %>
        <% end %>
        <%= form.label :is_hot, "üî• Hot (Th∆∞∆°ng Hi·ªáu M·ªõi - ∆Øu ƒê√£i ƒê·∫∑c Bi·ªát N√≥ng)", class: "status-flag-label #{'disabled' unless current_admin_user&.super_admin?}" %>
      </div>
      
      <div style="display: flex; align-items: center; gap: 8px;">
        <% if current_admin_user&.super_admin? %>
          <%= form.check_box :is_preorder %>
        <% else %>
          <%= form.check_box :is_preorder, { disabled: true } %>
        <% end %>
        <%= form.label :is_preorder, "üì¶ Preorder (ƒê·∫∑t tr∆∞·ªõc)", class: "status-flag-label #{'disabled' unless current_admin_user&.super_admin?}" %>
      </div>
      
      <div style="display: flex; align-items: center; gap: 8px;">
        <% if current_admin_user&.super_admin? %>
          <%= form.check_box :is_trending %>
        <% else %>
          <%= form.check_box :is_trending, { disabled: true } %>
        <% end %>
        <%= form.label :is_trending, "üìà Trending (Xu h∆∞·ªõng)", class: "status-flag-label #{'disabled' unless current_admin_user&.super_admin?}" %>
      </div>
      
      <div style="display: flex; align-items: center; gap: 8px;">
        <% if current_admin_user&.super_admin? %>
          <%= form.check_box :is_ending_soon %>
        <% else %>
          <%= form.check_box :is_ending_soon, { disabled: true } %>
        <% end %>
        <%= form.label :is_ending_soon, "‚è∞ Ending Soon (S·∫Øp k·∫øt th√∫c)", class: "status-flag-label #{'disabled' unless current_admin_user&.super_admin?}" %>
      </div>
      
      <div style="display: flex; align-items: center; gap: 8px;">
        <% if current_admin_user&.super_admin? %>
          <%= form.check_box :is_arriving_soon %>
        <% else %>
          <%= form.check_box :is_arriving_soon, { disabled: true } %>
        <% end %>
        <%= form.label :is_arriving_soon, "üöö Arriving Soon (S·∫Øp v·ªÅ h√†ng)", class: "status-flag-label #{'disabled' unless current_admin_user&.super_admin?}" %>
      </div>
    </div>
    
    <% unless current_admin_user&.super_admin? %>
      <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
        <div style="color: #856404; font-size: 14px;">
          <strong>‚ÑπÔ∏è Th√¥ng b√°o:</strong> Ch·ªâ Super Admin m·ªõi c√≥ quy·ªÅn ch·ªânh s·ª≠a Status & Flags c·ªßa s·∫£n ph·∫©m.
        </div>
      </div>
    <% end %>
  </div>

  <!-- Product Images Section -->
  <div class="field-unit">
    <div class="field-unit__label">
      <label>Product Images</label>
    </div>
    <div class="field-unit__field">
      <!-- Bulk Image Upload -->
      <div class="bulk-upload-section" style="margin-bottom: 20px; padding: 15px; border: 2px dashed #007bff; border-radius: 8px; background: #f8f9fa;">
        <label for="bulk-image-upload" style="display: block; margin-bottom: 10px; font-weight: bold;">üì∏ Upload Multiple Images</label>
        <p style="margin: 0 0 10px; color: #666; font-size: 14px;">
          Choose multiple images or drag and drop them here. Supported formats: JPG, PNG, WebP (max 5MB each)
        </p>
        <input type="file" id="bulk-image-upload" multiple accept="image/jpeg,image/jpg,image/png,image/webp" style="margin-bottom: 10px;">
        <div id="bulk-preview-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 15px;"></div>
        <button type="button" id="add-bulk-images" class="btn btn-primary" style="margin-top: 10px; display: none;">üì∏ Add Selected Images</button>
      </div>
      
      <div id="product-images-container" class="sortable-container">
        <%= form.fields_for :product_images do |image_form| %>
          <div class="nested-field-wrapper product-image-fields sortable-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; position: relative; cursor: move;" data-sort-order="<%= image_form.object.sort_order || 0 %>">
            <!-- Drag Handle -->
            <div class="drag-handle" style="position: absolute; top: 10px; right: 10px; cursor: grab; color: #666; font-size: 18px; z-index: 10;">‚ãÆ‚ãÆ</div>
            
            <!-- Current Image Preview -->
            <% if image_form.object.image? %>
              <div class="current-image-preview" style="margin-bottom: 15px;">
                <label>Current Image:</label>
                <div style="position: relative; display: inline-block;">
                  <img src="<%= image_form.object.image.url %>" alt="<%= image_form.object.alt_text %>" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
              </div>
            <% end %>
            
            <div class="field-unit">
              <label>Image</label>
              <%= image_form.file_field :image, accept: "image/jpeg,image/jpg,image/png,image/webp", class: "text-field image-upload", data: { preview_target: "image_preview_#{image_form.object.object_id}" } %>
            </div>
            
            <!-- New Image Preview -->
            <div class="field-unit">
              <div id="image_preview_<%= image_form.object.object_id %>" class="image-preview" style="margin-top: 10px; display: none;">
                <img class="preview-image" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>
            
            <div class="field-unit">
              <label>Sort Order</label>
              <%= image_form.number_field :sort_order, value: image_form.object.sort_order || 0, class: "text-field sort-order-field" %>
            </div>
            <div class="field-unit">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div class="toggle">
                  <%= image_form.check_box :is_primary, { class: "toggle-input", id: "image_is_primary_#{image_form.object.object_id}" } %>
                  <label for="image_is_primary_<%= image_form.object.object_id %>" class="toggle-label">
                    <span class="toggle-knob"></span>
                  </label>
                </div>
                <div>
                  <div id="image-primary-label-<%= image_form.object.object_id %>" style="font-weight: 700; color: #1f2937;">
                    <%= image_form.object.is_primary ? 'H√¨nh ·∫£nh ch√≠nh' : 'H√¨nh ·∫£nh ph·ª•' %>
                  </div>
                  <div style="font-size: 12px; color: #6b7280;">
                    B·∫≠t ƒë·ªÉ ƒë·∫∑t l√†m h√¨nh ·∫£nh ch√≠nh c·ªßa s·∫£n ph·∫©m
                  </div>
                </div>
              </div>
            </div>
            <div class="field-unit" style="display: flex; justify-content: flex-end; margin-top: 15px;">
              <%= image_form.hidden_field :_destroy %>
              <button type="button" class="remove-nested-field btn btn-outline-danger btn-sm">üóëÔ∏è Remove Image</button>
            </div>
          </div>
        <% end %>
      </div>
      
      <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
        <button type="button" id="add-product-image" class="btn btn-success">üì∏ Add Image</button>
      </div>
    </div>
  </div>

  <!-- Product Descriptions Section -->
  <div class="field-unit">
    <div class="field-unit__label">
      <label>Product Descriptions</label>
    </div>
    <div class="field-unit__field">
      <div id="product-descriptions-container" class="sortable-container">
        <%= form.fields_for :product_descriptions do |desc_form| %>
          <div class="nested-field-wrapper product-description-fields sortable-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; position: relative; cursor: move;" data-sort-order="<%= desc_form.object.sort_order || 0 %>">
            <!-- Drag Handle -->
            <div class="drag-handle" style="position: absolute; top: 10px; right: 10px; cursor: grab; color: #666; font-size: 18px; z-index: 10;">‚ãÆ‚ãÆ</div>
            
            <div class="field-unit">
              <label>Title</label>
              <%= desc_form.text_field :title, class: "text-field" %>
            </div>
             <div class="field-unit">
              <label>Content</label>
               <div class="field-unit__field" style="margin-left: 0;">
                 <%= desc_form.text_area :content,
                     class: "ckeditor text-field",
                     id: "product_descriptions_content_#{desc_form.object.object_id}",
                     rows: 10 %>
               </div>
             </div>
            <div class="field-unit">
              <label>Sort Order</label>
              <%= desc_form.number_field :sort_order, value: desc_form.object.sort_order || 0, class: "text-field sort-order-field" %>
            </div>
            <div class="field-unit" style="display: flex; justify-content: flex-end; margin-top: 15px;">
              <%= desc_form.hidden_field :_destroy %>
              <button type="button" class="remove-nested-field btn btn-outline-danger btn-sm">üóëÔ∏è Remove Description</button>
            </div>
          </div>
        <% end %>
      </div>
      
      <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
        <button type="button" id="add-product-description" class="btn btn-success">üìù Add Description</button>
      </div>
    </div>
  </div>

  <!-- Product Specifications Section -->
  <div class="field-unit">
    <div class="field-unit__label">
      <label>Product Specifications</label>
    </div>
    <div class="field-unit__field">
      <div id="product-specifications-container" class="sortable-container">
        <%= form.fields_for :product_specifications do |spec_form| %>
          <div class="nested-field-wrapper product-specification-fields sortable-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; position: relative; cursor: move;" data-sort-order="<%= spec_form.object.sort_order || 0 %>">
            <!-- Drag Handle -->
            <div class="drag-handle" style="position: absolute; top: 10px; right: 10px; cursor: grab; color: #666; font-size: 18px; z-index: 10;">‚ãÆ‚ãÆ</div>
            
            <div class="field-unit">
              <label>Name</label>
              <%= spec_form.text_field :spec_name, class: "text-field" %>
            </div>
            <div class="field-unit">
              <label>Value</label>
              <%= spec_form.text_field :spec_value, class: "text-field" %>
            </div>
            <div class="field-unit">
              <label>Unit</label>
              <%= spec_form.text_field :unit, class: "text-field" %>
            </div>
            <div class="field-unit">
              <label>Sort Order</label>
              <%= spec_form.number_field :sort_order, value: spec_form.object.sort_order || 0, class: "text-field sort-order-field" %>
            </div>
            <div class="field-unit" style="display: flex; justify-content: flex-end; margin-top: 15px;">
              <%= spec_form.hidden_field :_destroy %>
              <button type="button" class="remove-nested-field btn btn-outline-danger btn-sm">üóëÔ∏è Remove Specification</button>
            </div>
          </div>
        <% end %>
      </div>

      <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
        <button type="button" id="add-product-specification" class="btn btn-success">‚öôÔ∏è Add Specification</button>
      </div>
    </div>
  </div>

  <!-- Product Videos Section -->
  <div class="field-unit">
    <div class="field-unit__label">
      <label>Product Videos</label>
    </div>
    <div class="field-unit__field">
      <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px; font-size: 14px;">
        üìπ <strong>H·ªó tr·ª£:</strong> YouTube v√† Vimeo URLs. V√≠ d·ª•: https://www.youtube.com/watch?v=ABC123 ho·∫∑c https://youtu.be/ABC123
      </div>

      <div id="product-videos-container" class="sortable-container">
        <%= form.fields_for :product_videos do |video_form| %>
          <div class="nested-field-wrapper product-video-fields sortable-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; position: relative; cursor: move;" data-sort-order="<%= video_form.object.sort_order || 0 %>">
            <!-- Drag Handle -->
            <div class="drag-handle" style="position: absolute; top: 10px; right: 10px; cursor: grab; color: #666; font-size: 18px; z-index: 10;">‚ãÆ‚ãÆ</div>
            
            <div class="field-unit">
              <label>Video URL</label>
              <%= video_form.url_field :url, class: "text-field", placeholder: "https://www.youtube.com/watch?v=..." %>
            </div>
            <div class="field-unit">
              <label>Title</label>
              <%= video_form.text_field :title, class: "text-field", placeholder: "Video title" %>
            </div>
            <div class="field-unit">
              <label>Description</label>
              <%= video_form.text_area :description, rows: 3, class: "text-field", placeholder: "Video description (optional)" %>
            </div>
            <div class="field-unit">
              <label>Sort Order</label>
              <%= video_form.number_field :sort_order, value: video_form.object.sort_order || 0, class: "text-field sort-order-field" %>
            </div>
            <div class="field-unit">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div class="toggle">
                  <%= video_form.check_box :is_active, { class: "toggle-input", id: "video_is_active_#{video_form.object.object_id}" } %>
                  <label for="video_is_active_<%= video_form.object.object_id %>" class="toggle-label">
                    <span class="toggle-knob"></span>
                  </label>
                </div>
                <div>
                  <div id="video-active-label-<%= video_form.object.object_id %>" style="font-weight: 700; color: #1f2937;">
                    Video ƒëang ho·∫°t ƒë·ªông
                  </div>
                  <div style="font-size: 12px; color: #6b7280;">
                    B·∫≠t ƒë·ªÉ video ƒë∆∞·ª£c hi·ªÉn th·ªã tr√™n website
                  </div>
                </div>
              </div>
            </div>
            <div class="field-unit" style="display: flex; justify-content: flex-end; margin-top: 15px;">
              <%= video_form.hidden_field :_destroy %>
              <button type="button" class="remove-nested-field btn btn-outline-danger btn-sm">üóëÔ∏è Remove Video</button>
            </div>
          </div>
        <% end %>
      </div>
      
      <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
        <button type="button" id="add-product-video" class="btn btn-success">üé¨ Add Video</button>
      </div>
    </div>
  </div>

  <!-- Templates for new nested fields -->
  <script type="text/template" id="product-image-template">
    <div class="nested-field-wrapper product-image-fields sortable-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; position: relative; cursor: move;" data-sort-order="0">
      <!-- Drag Handle -->
      <div class="drag-handle" style="position: absolute; top: 10px; right: 10px; cursor: grab; color: #666; font-size: 18px; z-index: 10;">‚ãÆ‚ãÆ</div>
      
      <div class="field-unit">
        <label>Image</label>
        <input type="file" name="product[product_images_attributes][NEW_RECORD][image]" accept="image/jpeg,image/jpg,image/png,image/webp" class="text-field image-upload" data-preview-target="image_preview_NEW_RECORD">
      </div>

      <!-- New Image Preview -->
      <div class="field-unit">
        <div id="image_preview_NEW_RECORD" class="image-preview" style="margin-top: 10px; display: none;">
          <img class="preview-image" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
      </div>

      <div class="field-unit">
        <label>Sort Order</label>
        <input type="number" name="product[product_images_attributes][NEW_RECORD][sort_order]" value="0" class="text-field sort-order-field">
      </div>
      <div class="field-unit">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="toggle">
            <input type="checkbox" name="product[product_images_attributes][NEW_RECORD][is_primary]" value="1" class="toggle-input primary-toggle-hidden" id="image_is_primary_NEW_RECORD">
            <label for="image_is_primary_NEW_RECORD" class="toggle-label">
              <span class="toggle-knob"></span>
            </label>
          </div>
          <div>
            <div id="image-primary-label-NEW_RECORD" style="font-weight: 700; color: #1f2937;">
              H√¨nh ·∫£nh ph·ª•
            </div>
            <div style="font-size: 12px; color: #6b7280;">
              B·∫≠t ƒë·ªÉ ƒë·∫∑t l√†m h√¨nh ·∫£nh ch√≠nh c·ªßa s·∫£n ph·∫©m
            </div>
          </div>
        </div>
      </div>
      <div class="field-unit" style="display: flex; justify-content: flex-end; margin-top: 15px;">
        <button type="button" class="remove-nested-field btn btn-outline-danger btn-sm">üóëÔ∏è Remove Image</button>
      </div>
    </div>
  </script>

  <script type="text/template" id="product-description-template">
    <div class="nested-field-wrapper product-description-fields sortable-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; position: relative; cursor: move;" data-sort-order="0">
      <!-- Drag Handle -->
      <div class="drag-handle" style="position: absolute; top: 10px; right: 10px; cursor: grab; color: #666; font-size: 18px; z-index: 10;">‚ãÆ‚ãÆ</div>
      
      <div class="field-unit">
        <label>Title</label>
        <input type="text" name="product[product_descriptions_attributes][NEW_RECORD][title]" class="text-field">
      </div>
      <div class="field-unit">
        <label>Content</label>
        <textarea name="product[product_descriptions_attributes][NEW_RECORD][content]" 
                  class="ckeditor text-field" 
                  id="product_descriptions_content_NEW_RECORD"
                  rows="10"></textarea>
      </div>
      <div class="field-unit">
        <label>Sort Order</label>
        <input type="number" name="product[product_descriptions_attributes][NEW_RECORD][sort_order]" value="0" class="text-field sort-order-field">
      </div>
      <div class="field-unit" style="display: flex; justify-content: flex-end; margin-top: 15px;">
        <button type="button" class="remove-nested-field btn btn-outline-danger btn-sm">üóëÔ∏è Remove Description</button>
      </div>
    </div>
  </script>

  <script type="text/template" id="product-specification-template">
    <div class="nested-field-wrapper product-specification-fields sortable-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; position: relative; cursor: move;" data-sort-order="0">
      <!-- Drag Handle -->
      <div class="drag-handle" style="position: absolute; top: 10px; right: 10px; cursor: grab; color: #666; font-size: 18px; z-index: 10;">‚ãÆ‚ãÆ</div>
      
      <div class="field-unit">
        <label>Name</label>
        <input type="text" name="product[product_specifications_attributes][NEW_RECORD][spec_name]" class="text-field">
      </div>
      <div class="field-unit">
        <label>Value</label>
        <input type="text" name="product[product_specifications_attributes][NEW_RECORD][spec_value]" class="text-field">
      </div>
      <div class="field-unit">
        <label>Unit</label>
        <input type="text" name="product[product_specifications_attributes][NEW_RECORD][unit]" class="text-field">
      </div>
      <div class="field-unit">
        <label>Sort Order</label>
        <input type="number" name="product[product_specifications_attributes][NEW_RECORD][sort_order]" value="0" class="text-field sort-order-field">
      </div>
      <div class="field-unit" style="display: flex; justify-content: flex-end; margin-top: 15px;">
        <button type="button" class="remove-nested-field btn btn-outline-danger btn-sm">üóëÔ∏è Remove Specification</button>
      </div>
    </div>
  </script>

  <script type="text/template" id="product-video-template">
    <div class="nested-field-wrapper product-video-fields sortable-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; position: relative; cursor: move;" data-sort-order="0">
      <!-- Drag Handle -->
      <div class="drag-handle" style="position: absolute; top: 10px; right: 10px; cursor: grab; color: #666; font-size: 18px; z-index: 10;">‚ãÆ‚ãÆ</div>
      
      <div class="field-unit">
        <label>Video URL</label>
        <input type="url" name="product[product_videos_attributes][NEW_RECORD][url]" class="text-field" placeholder="https://www.youtube.com/watch?v=...">
      </div>
      <div class="field-unit">
        <label>Title</label>
        <input type="text" name="product[product_videos_attributes][NEW_RECORD][title]" class="text-field" placeholder="Video title">
      </div>
      <div class="field-unit">
        <label>Description</label>
        <textarea name="product[product_videos_attributes][NEW_RECORD][description]" rows="3" class="text-field" placeholder="Video description (optional)"></textarea>
      </div>
      <div class="field-unit">
        <label>Sort Order</label>
        <input type="number" name="product[product_videos_attributes][NEW_RECORD][sort_order]" value="0" class="text-field sort-order-field">
      </div>
      <div class="field-unit">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="toggle">
            <input type="checkbox" name="product[product_videos_attributes][NEW_RECORD][is_active]" value="1" checked class="toggle-input" id="video_is_active_NEW_RECORD">
            <label for="video_is_active_NEW_RECORD" class="toggle-label">
              <span class="toggle-knob"></span>
            </label>
          </div>
          <div>
            <div id="video-active-label-NEW_RECORD" style="font-weight: 700; color: #1f2937;">
              Video ƒëang ho·∫°t ƒë·ªông
            </div>
            <div style="font-size: 12px; color: #6b7280;">
              B·∫≠t ƒë·ªÉ video ƒë∆∞·ª£c hi·ªÉn th·ªã tr√™n website
            </div>
          </div>
        </div>
      </div>
      <div class="field-unit" style="display: flex; justify-content: flex-end; margin-top: 15px;">
        <button type="button" class="remove-nested-field btn btn-outline-danger btn-sm">üóëÔ∏è Remove Video</button>
      </div>
    </div>
  </script>

  <div class="form-actions" style="display: flex; justify-content: flex-end; margin-top: 30px;">
    <% if page.resource.persisted? %>
      <%= form.submit "‚ú® C·∫≠p Nh·∫≠t S·∫£n Ph·∫©m", class: "btn btn-primary btn-create-product" %>
    <% else %>
      <%= form.submit "‚ú® T·∫°o S·∫£n Ph·∫©m M·ªõi", class: "btn btn-primary btn-create-product" %>
    <% end %>
  </div>
<% end %>

<script type="text/javascript">
  function initializeCKEditorForProduct() {
    if (typeof CKEDITOR === 'undefined') {
      setTimeout(initializeCKEditorForProduct, 1000);
      return;
    }
    
    if (!CKEDITOR.env) {
      setTimeout(initializeCKEditorForProduct, 500);
      return;
    }
    
    var textareas = document.querySelectorAll('textarea.ckeditor');
    
    if (textareas.length === 0) {
      setTimeout(initializeCKEditorForProduct, 500);
      return;
    }
    
    textareas.forEach(function(textarea, index) {
      if (CKEDITOR.instances[textarea.id]) {
        return;
      }

      if (textarea.offsetParent === null) {
        return;
      }

      try {
        CKEDITOR.replace(textarea.id, {
          height: 400,
          width: '100%',
          maxWidth: '100%',
          language: 'vi',
          toolbar: [
            { name: 'document', items: [ 'Source', '-', 'Preview', '-', 'Templates' ] },
            { name: 'clipboard', items: [ 'Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo' ] },
            { name: 'editing', items: [ 'Find', 'Replace', '-', 'SelectAll' ] },
            '/',
            { name: 'basicstyles', items: [ 'Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'RemoveFormat' ] },
            { name: 'paragraph', items: [ 'NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote', 'CreateDiv', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock' ] },
            { name: 'links', items: [ 'Link', 'Unlink', 'Anchor' ] },
            '/',
            { name: 'insert', items: [ 'Image', 'Table', 'HorizontalRule', 'SpecialChar' ] },
            { name: 'styles', items: [ 'Styles', 'Format', 'Font', 'FontSize' ] },
            { name: 'colors', items: [ 'TextColor', 'BGColor' ] },
            { name: 'tools', items: [ 'Maximize', 'ShowBlocks' ] }
          ],
          removeDialogTabs: 'image:advanced;link:advanced'
        });
      } catch (error) {
        // Silent error handling
      }
    });
  }
  
  function reinitializeCKEditor() {
    setTimeout(initializeCKEditorForProduct, 100);
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initializeCKEditorForProduct, 1000);
    });
  } else {
    setTimeout(initializeCKEditorForProduct, 1000);
  }
  
  window.addEventListener('load', function() {
    setTimeout(initializeCKEditorForProduct, 1500);
  });
  
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
      setTimeout(initializeCKEditorForProduct, 500);
    }
  });
  
  setTimeout(function() {
    initializeCKEditorForProduct();
  }, 3000);
  
  // Image Upload and Preview Functionality
  function initializeImagePreview() {
    // Handle file input changes for image preview
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('image-upload')) {
        handleImagePreview(e.target);
      }
      
      if (e.target.id === 'bulk-image-upload') {
        handleBulkImagePreview(e.target);
      }
    });
    
    // Handle remove preview buttons
    document.addEventListener('click', function(e) {
      
      
      if (e.target.classList.contains('remove-bulk-preview')) {
        removeBulkPreview(e.target);
      }
      
      if (e.target.id === 'add-bulk-images') {
        addBulkImagesToForm();
      }
      
      // Handle Add buttons for different sections
      if (e.target.id === 'add-product-description') {
        e.preventDefault();
        e.stopPropagation();
        addProductDescription();
      }
      
      if (e.target.id === 'add-product-specification') {
        e.preventDefault();
        e.stopPropagation();
        addProductSpecification();
      }
      
      if (e.target.id === 'add-product-video') {
        e.preventDefault();
        e.stopPropagation();
        addProductVideo();
      }
    });
  }
  
  function handleImagePreview(fileInput) {
    const file = fileInput.files[0];
    const previewTarget = fileInput.getAttribute('data-preview-target');
    const previewContainer = document.getElementById(previewTarget);
    
    if (!file || !previewContainer) return;
    
    // Validate file type
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    if (!validTypes.includes(file.type)) {
      alert('Ch·ªâ ch·∫•p nh·∫≠n c√°c ƒë·ªãnh d·∫°ng: JPG, PNG, WebP');
      fileInput.value = '';
      return;
    }
    
    // Validate file size (max 5MB)
    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
      alert('K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB');
      fileInput.value = '';
      return;
    }
    
    // Create preview
    const reader = new FileReader();
    reader.onload = function(e) {
      const previewImage = previewContainer.querySelector('.preview-image');
      previewImage.src = e.target.result;
      previewContainer.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
  
  
  
  // Bulk image upload functions
  let bulkFiles = [];
  
  function handleBulkImagePreview(fileInput) {
    const files = Array.from(fileInput.files);
    const previewContainer = document.getElementById('bulk-preview-container');
    const addButton = document.getElementById('add-bulk-images');
    
    // Clear previous previews
    previewContainer.innerHTML = '';
    bulkFiles = [];
    
    files.forEach((file, index) => {
      // Validate file type
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
      if (!validTypes.includes(file.type)) {
        alert(`File "${file.name}" kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng. Ch·ªâ ch·∫•p nh·∫≠n: JPG, PNG, WebP`);
        return;
      }
      
      // Validate file size (max 5MB)
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        alert(`File "${file.name}" v∆∞·ª£t qu√° 5MB`);
        return;
      }
      
      bulkFiles.push(file);
      
      // Create preview
      const reader = new FileReader();
      reader.onload = function(e) {
        const previewDiv = document.createElement('div');
        previewDiv.className = 'bulk-preview-item';
        previewDiv.style.cssText = 'position: relative; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; max-width: 100%;';
        previewDiv.dataset.fileIndex = index;
        
        previewDiv.innerHTML = `
          <img src="${e.target.result}" style="max-width: 100%; height: 120px; object-fit: cover;">
          <div style="padding: 5px; font-size: 11px; background: #f8f9fa;">
            <div style="font-weight: bold; margin-bottom: 2px;">${file.name}</div>
            <div>${(file.size / 1024).toFixed(1)} KB</div>
          </div>
          <button type="button" class="remove-bulk-preview" data-file-index="${index}" 
                  style="position: absolute; top: 5px; right: 5px; width: 20px; height: 20px; 
                         border-radius: 50%; background: #dc3545; color: white; border: none; 
                         cursor: pointer; font-size: 12px; display: flex; align-items: center; 
                         justify-content: center;">√ó</button>
        `;
        
        previewContainer.appendChild(previewDiv);
      };
      reader.readAsDataURL(file);
    });
    
    if (bulkFiles.length > 0) {
      addButton.style.display = 'block';
      addButton.textContent = `Add ${bulkFiles.length} Image(s)`;
    } else {
      addButton.style.display = 'none';
    }
  }
  
  function removeBulkPreview(button) {
    const fileIndex = parseInt(button.dataset.fileIndex);
    const previewItem = button.closest('.bulk-preview-item');
    const addButton = document.getElementById('add-bulk-images');
    
    // Remove from bulkFiles array
    bulkFiles = bulkFiles.filter((_, index) => index !== fileIndex);
    
    // Remove preview element
    previewItem.remove();
    
    // Update add button
    if (bulkFiles.length > 0) {
      addButton.textContent = `Add ${bulkFiles.length} Image(s)`;
    } else {
      addButton.style.display = 'none';
    }
    
    // Update file indices for remaining previews
    const remainingPreviews = document.querySelectorAll('.bulk-preview-item');
    remainingPreviews.forEach((preview, newIndex) => {
      preview.dataset.fileIndex = newIndex;
      const removeBtn = preview.querySelector('.remove-bulk-preview');
      removeBtn.dataset.fileIndex = newIndex;
    });
  }
  
  function addBulkImagesToForm() {
    const container = document.getElementById('product-images-container');
    const template = document.getElementById('product-image-template');
    
    if (!container || !template || bulkFiles.length === 0) return;
    
    // First, clean up any empty fields
    const emptyFields = container.querySelectorAll('.product-image-fields');
    emptyFields.forEach(field => {
      const fileInput = field.querySelector('.image-upload');
      const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
      const hasCurrentImage = field.querySelector('.current-image-preview');
      
      // If field has no file and no current image, remove it
      if (!hasFile && !hasCurrentImage) {
        field.remove();
      }
    });
    
    // Get current number of existing image fields to calculate proper sort order
    const existingFields = container.querySelectorAll('.product-image-fields');
    let nextSortOrder = existingFields.length;
    
    bulkFiles.forEach((file, index) => {
      const newIndex = Date.now() + index;
      let newField = template.innerHTML.replace(/NEW_RECORD/g, newIndex);
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = newField;
      wrapper.className = 'nested-field-wrapper product-image-fields sortable-item';
      wrapper.setAttribute('data-sort-order', nextSortOrder + index);
      
      container.appendChild(wrapper);
      
      // Set the file to the file input
      const fileInput = wrapper.querySelector('.image-upload');
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      fileInput.files = dataTransfer.files;
      
      // Set correct sort order
      const sortOrderField = wrapper.querySelector('.sort-order-field');
      if (sortOrderField) {
        sortOrderField.value = nextSortOrder + index;
      }
      
      // Trigger preview for this field
      handleImagePreview(fileInput);
      
      // Initialize event listeners for new field
      fileInput.addEventListener('change', function(e) {
        handleImagePreview(e.target);
      });
      
      
      // Add drag handle
      const dragHandle = document.createElement('div');
      dragHandle.className = 'drag-handle';
      dragHandle.innerHTML = '‚ãÆ‚ãÆ';
      dragHandle.style.cssText = 'position: absolute; top: 10px; right: 10px; cursor: grab; color: #666; font-size: 18px; z-index: 10;';
      wrapper.appendChild(dragHandle);
    });
    
    // Update sort orders for all fields after adding new ones
    updateSortOrders();
    
    // Clear bulk upload
    document.getElementById('bulk-image-upload').value = '';
    document.getElementById('bulk-preview-container').innerHTML = '';
    document.getElementById('add-bulk-images').style.display = 'none';
    bulkFiles = [];
  }
  
  // Add Product Description
  function addProductDescription() {
    const container = document.getElementById('product-descriptions-container');
    const template = document.getElementById('product-description-template');
    
    if (!container || !template) return;
    
    // Prevent duplicate calls
    if (container.dataset.adding === 'true') return;
    container.dataset.adding = 'true';
    
    // Get next sort order
    const existingItems = container.querySelectorAll('.sortable-item');
    const nextSortOrder = existingItems.length;
    
    // Clone template
    const wrapper = document.createElement('div');
    wrapper.innerHTML = template.innerHTML;
    const newItem = wrapper.firstElementChild;
    
    // Update sort order
    const sortOrderField = newItem.querySelector('.sort-order-field');
    if (sortOrderField) {
      sortOrderField.value = nextSortOrder;
    }
    newItem.setAttribute('data-sort-order', nextSortOrder);
    
    // Add to container
    container.appendChild(newItem);
    
    // Update sort orders for all items
    updateSortOrdersForContainer(container);
    
    // Reset flag
    setTimeout(() => {
      container.dataset.adding = 'false';
    }, 100);
  }
  
  // Add Product Specification
  function addProductSpecification() {
    const container = document.getElementById('product-specifications-container');
    const template = document.getElementById('product-specification-template');
    
    if (!container || !template) return;
    
    // Prevent duplicate calls
    if (container.dataset.adding === 'true') return;
    container.dataset.adding = 'true';
    
    // Get next sort order
    const existingItems = container.querySelectorAll('.sortable-item');
    const nextSortOrder = existingItems.length;
    
    // Clone template
    const wrapper = document.createElement('div');
    wrapper.innerHTML = template.innerHTML;
    const newItem = wrapper.firstElementChild;
    
    // Update sort order
    const sortOrderField = newItem.querySelector('.sort-order-field');
    if (sortOrderField) {
      sortOrderField.value = nextSortOrder;
    }
    newItem.setAttribute('data-sort-order', nextSortOrder);
    
    // Add to container
    container.appendChild(newItem);
    
    // Update sort orders for all items
    updateSortOrdersForContainer(container);
    
    // Reset flag
    setTimeout(() => {
      container.dataset.adding = 'false';
    }, 100);
  }
  
  // Add Product Video
  function addProductVideo() {
    const container = document.getElementById('product-videos-container');
    const template = document.getElementById('product-video-template');
    
    if (!container || !template) return;
    
    // Prevent duplicate calls
    if (container.dataset.adding === 'true') return;
    container.dataset.adding = 'true';
    
    // Get next sort order
    const existingItems = container.querySelectorAll('.sortable-item');
    const nextSortOrder = existingItems.length;
    
    // Clone template
    const wrapper = document.createElement('div');
    wrapper.innerHTML = template.innerHTML;
    const newItem = wrapper.firstElementChild;
    
    // Update sort order
    const sortOrderField = newItem.querySelector('.sort-order-field');
    if (sortOrderField) {
      sortOrderField.value = nextSortOrder;
    }
    newItem.setAttribute('data-sort-order', nextSortOrder);
    
    // Add to container
    container.appendChild(newItem);
    
    // Update sort orders for all items
    updateSortOrdersForContainer(container);
    
    // Reset flag
    setTimeout(() => {
      container.dataset.adding = 'false';
    }, 100);
  }
  
  // Update sort orders for a specific container
  function updateSortOrdersForContainer(container) {
    const items = container.querySelectorAll('.sortable-item');
    let validIndex = 0;
    
    items.forEach((item, index) => {
      // For images, check if they have files or current images
      const fileInput = item.querySelector('.image-upload');
      const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
      const hasCurrentImage = item.querySelector('.current-image-preview');
      
      // For other sections, always update sort order
      const isImageSection = container.id === 'product-images-container';
      const shouldUpdate = isImageSection ? (hasFile || hasCurrentImage) : true;
      
      if (shouldUpdate) {
        const sortOrderField = item.querySelector('.sort-order-field');
        if (sortOrderField) {
          sortOrderField.value = validIndex;
        }
        item.setAttribute('data-sort-order', validIndex);
        validIndex++;
      }
    });
  }
  
  // Drag & Drop functionality
  function initializeDragAndDrop() {
    const containers = [
      'product-images-container',
      'product-descriptions-container', 
      'product-specifications-container',
      'product-videos-container'
    ];
    
    containers.forEach(containerId => {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      initializeContainerDragAndDrop(container);
    });
  }
  
  function initializeContainerDragAndDrop(container) {

    let draggedElement = null;
    let draggedIndex = -1;
    let dragOffset = { x: 0, y: 0 };
    let isDragging = false;
    let originalSize = { width: 0, height: 0 };

    // Use event delegation to handle drag events
    container.addEventListener('mousedown', function(e) {
      if (e.target.classList.contains('drag-handle')) {
        handleMouseDown(e);
      }
    });

    // Ensure all drag handles exist on page load
    function ensureAllDragHandles() {
      const items = container.querySelectorAll('.sortable-item');
      items.forEach((item) => {
        let dragHandle = item.querySelector('.drag-handle');
        if (!dragHandle) {
          dragHandle = document.createElement('div');
          dragHandle.className = 'drag-handle';
          dragHandle.innerHTML = '‚ãÆ‚ãÆ';
          dragHandle.style.cssText = 'position: absolute; top: 10px; right: 10px; cursor: grab; color: #666; font-size: 18px; z-index: 10;';
          item.appendChild(dragHandle);
        }
      });
    }

    // Initialize drag handles
    ensureAllDragHandles();

    // Function to update drag listeners for all items (for compatibility)
    function updateDragListeners() {
      // Event delegation handles this automatically
    }

    function handleMouseDown(e) {
      e.preventDefault();
      draggedElement = e.target.closest('.sortable-item');
      if (!draggedElement) return;

      draggedIndex = Array.from(container.children).indexOf(draggedElement);
      
      // Calculate offset from mouse to element
      const rect = draggedElement.getBoundingClientRect();
      dragOffset.x = e.clientX - rect.left;
      dragOffset.y = e.clientY - rect.top;
      
      // Store original size
      originalSize.width = rect.width;
      originalSize.height = rect.height;
      
      isDragging = true;
      draggedElement.classList.add('dragging');

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    }

    function handleMouseMove(e) {
      if (!draggedElement || !isDragging) return;

      e.preventDefault();
      
      // Move the element to follow mouse cursor
      const newX = e.clientX - dragOffset.x;
      const newY = e.clientY - dragOffset.y;
      
      draggedElement.style.position = 'fixed';
      draggedElement.style.left = newX + 'px';
      draggedElement.style.top = newY + 'px';
      draggedElement.style.zIndex = '1000';
      draggedElement.style.pointerEvents = 'none';
      draggedElement.style.width = originalSize.width + 'px';
      draggedElement.style.height = originalSize.height + 'px';

      const items = Array.from(container.children);
      
      // Find the item we're hovering over
      const mouseY = e.clientY;
      let hoveredItem = null;
      
      // Clear all drag-over classes first
      items.forEach(item => item.classList.remove('drag-over'));
      
      // Sort items by position to handle overlapping correctly
      const sortedItems = items
        .filter(item => item !== draggedElement)
        .map(item => ({
          element: item,
          rect: item.getBoundingClientRect()
        }))
        .sort((a, b) => a.rect.top - b.rect.top);
      
      // Find the closest item
      for (let i = 0; i < sortedItems.length; i++) {
        const item = sortedItems[i];
        const itemCenter = item.rect.top + item.rect.height / 2;
        
        if (mouseY < itemCenter) {
          hoveredItem = item.element;
          break;
        }
      }
      
      // Add visual feedback
      if (hoveredItem) {
        hoveredItem.classList.add('drag-over');
      }

    }

    function handleMouseUp(e) {
      if (!draggedElement || !isDragging) return;

      e.preventDefault();
      
      // First, reset element position to get accurate measurements
      draggedElement.style.position = '';
      draggedElement.style.left = '';
      draggedElement.style.top = '';
      draggedElement.style.zIndex = '';
      draggedElement.style.pointerEvents = '';
      draggedElement.style.width = '';
      draggedElement.style.height = '';
      
      // Force reflow to ensure element is back in normal flow
      draggedElement.offsetHeight;
      
      // Now get fresh measurements
      const items = Array.from(container.children);
      
      // Find the target position based on mouse position
      let targetIndex = -1;
      const mouseY = e.clientY;
      
      // Get all items except the dragged one
      const otherItems = items.filter(item => item !== draggedElement);
      
      // Find the item that the mouse is closest to
      let closestItem = null;
      let minDistance = Infinity;
      
      otherItems.forEach(item => {
        const rect = item.getBoundingClientRect();
        const itemCenter = rect.top + rect.height / 2;
        const distance = Math.abs(mouseY - itemCenter);
        
        if (distance < minDistance) {
          minDistance = distance;
          closestItem = item;
        }
      });
      
      if (closestItem) {
        // Find the original index of the closest item
        targetIndex = Array.from(container.children).indexOf(closestItem);
        
        // If mouse is above the center of the closest item, insert before it
        // If mouse is below the center, insert after it
        const rect = closestItem.getBoundingClientRect();
        const itemCenter = rect.top + rect.height / 2;
        
        if (mouseY > itemCenter) {
          targetIndex += 1; // Insert after the closest item
        }
      }
      
      // If no target found, move to end
      if (targetIndex === -1) {
        targetIndex = items.length - 1;
      }

      // Move the element
      if (targetIndex !== draggedIndex) {
        // Remove the dragged element from its current position
        container.removeChild(draggedElement);
        
        // Get the updated items array (without the dragged element)
        const updatedItems = Array.from(container.children);
        
        // Adjust target index after removal
        let adjustedTargetIndex = targetIndex;
        if (targetIndex > draggedIndex) {
          adjustedTargetIndex = targetIndex - 1; // Items after dragged element shift up
        }
        
        if (adjustedTargetIndex >= updatedItems.length) {
          // Moving to the end
          container.appendChild(draggedElement);
        } else {
          // Insert at the adjusted target position
          const targetElement = updatedItems[adjustedTargetIndex];
          container.insertBefore(draggedElement, targetElement);
        }
        
        // Update sort order values
        updateSortOrders();
      }

      // Clean up
      items.forEach(item => item.classList.remove('drag-over'));
      draggedElement.classList.remove('dragging');
      draggedElement = null;
      draggedIndex = -1;
      isDragging = false;

      // Ensure drag handles are visible after drag operation
      setTimeout(() => {
        ensureDragHandlesVisible();
      }, 100);

      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    }

    function updateSortOrders() {
      const items = container.querySelectorAll('.sortable-item');
      let validIndex = 0;
      
      items.forEach((item, index) => {
        // For images, check if they have files or current images
        const fileInput = item.querySelector('.image-upload');
        const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
        const hasCurrentImage = item.querySelector('.current-image-preview');
        
        // For other sections, always update sort order
        const isImageSection = container.id === 'product-images-container';
        const shouldUpdate = isImageSection ? (hasFile || hasCurrentImage) : true;
        
        if (shouldUpdate) {
          const sortOrderField = item.querySelector('.sort-order-field');
          if (sortOrderField) {
            sortOrderField.value = validIndex;
          }
          item.setAttribute('data-sort-order', validIndex);
          validIndex++;
        }
      });
      
      // Ensure drag handles are properly managed after sort order update
      ensureDragHandlesVisible();
    }

    // Function to ensure all drag handles are visible
    function ensureDragHandlesVisible() {
      const items = container.querySelectorAll('.sortable-item');
      items.forEach((item) => {
        // Remove ALL existing drag handles first to avoid duplicates
        const existingHandles = item.querySelectorAll('.drag-handle');
        existingHandles.forEach(handle => handle.remove());
        
        // Create a single new drag handle
        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.innerHTML = '‚ãÆ‚ãÆ';
        dragHandle.style.cssText = 'position: absolute; top: 10px; right: 10px; cursor: grab; color: #666; font-size: 18px; z-index: 10;';
        
        // Ensure the item has relative positioning for absolute positioning to work
        if (getComputedStyle(item).position === 'static') {
          item.style.position = 'relative';
        }
        
        // Append the drag handle to the item
        item.appendChild(dragHandle);
      });
    }

    // Event delegation handles new items automatically
    // No need for MutationObserver since we use event delegation
  }

  // Clean up empty image fields on page load
  function cleanupEmptyImageFields() {
    const container = document.getElementById('product-images-container');
    if (!container) return;
    
    const emptyFields = container.querySelectorAll('.product-image-fields');
    emptyFields.forEach(field => {
      const fileInput = field.querySelector('.image-upload');
      const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
      const hasCurrentImage = field.querySelector('.current-image-preview');
      
      // If field has no file and no current image, remove it
      if (!hasFile && !hasCurrentImage) {
        field.remove();
      }
    });
    
    // Update sort orders after cleanup
    updateSortOrders();
  }

  // Initialize image preview functionality
  initializeImagePreview();

  // Initialize drag & drop functionality
  initializeDragAndDrop();
  
  // Clean up empty fields on page load
  cleanupEmptyImageFields();
  
  // Function to clean up orphaned drag handles
  function cleanupOrphanedDragHandles() {
    const container = document.getElementById('product-images-container');
    if (!container) return;
    
    // Find all drag handles that are not inside sortable items
    const allDragHandles = document.querySelectorAll('.drag-handle');
    allDragHandles.forEach(handle => {
      const sortableItem = handle.closest('.sortable-item');
      if (!sortableItem || !container.contains(sortableItem)) {
        handle.remove();
      }
    });
  }
  
  // Monitor DOM changes to ensure drag handles are always visible
  function initializeDragHandleMonitor() {
    const container = document.getElementById('product-images-container');
    if (!container) return;
    
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList' || mutation.type === 'attributes') {
          // Small delay to ensure DOM is fully updated
          setTimeout(() => {
            cleanupOrphanedDragHandles();
            ensureDragHandlesVisible();
          }, 50);
        }
      });
    });
    
    observer.observe(container, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['class', 'style']
    });
  }
  
  // Initialize drag handle monitor
  initializeDragHandleMonitor();

  // Primary Image Toggle functionality
  function initializePrimaryImageToggles() {
    // Use event delegation for dynamically added elements
    document.addEventListener('change', function(e) {
      if (e.target && e.target.id && e.target.id.startsWith('image_is_primary_')) {
        const toggle = e.target;
        const labelId = 'image-primary-label-' + toggle.id.split('_').pop();
        const label = document.getElementById(labelId);

        if (label) {
          // Uncheck all other primary toggles
          const allToggles = document.querySelectorAll('input[id^="image_is_primary_"]');
          allToggles.forEach(function(otherToggle) {
            if (otherToggle !== toggle && otherToggle.checked) {
              otherToggle.checked = false;
              const otherLabelId = 'image-primary-label-' + otherToggle.id.split('_').pop();
              const otherLabel = document.getElementById(otherLabelId);
              if (otherLabel) {
                otherLabel.textContent = 'H√¨nh ·∫£nh ph·ª•';
              }
            }
          });
          
          // Update current label
          if (toggle.checked) {
            label.textContent = 'H√¨nh ·∫£nh ch√≠nh';
          } else {
            label.textContent = 'H√¨nh ·∫£nh ph·ª•';
          }
        }
      }
    });

    // Initialize existing toggles
    const existingToggles = document.querySelectorAll('input[id^="image_is_primary_"]');
    existingToggles.forEach(function(toggle) {
      const labelId = 'image-primary-label-' + toggle.id.split('_').pop();
      const label = document.getElementById(labelId);
      
      if (label) {
        if (toggle.checked) {
          label.textContent = 'H√¨nh ·∫£nh ch√≠nh';
        } else {
          label.textContent = 'H√¨nh ·∫£nh ph·ª•';
        }
      }
    });
  }

  // Initialize primary image toggles
  initializePrimaryImageToggles();
</script>

<style>
  .btn-xs {
    padding: 2px 6px;
    font-size: 11px;
    line-height: 1.2;
    border-radius: 3px;
  }
  
  .image-upload {
    border: 2px dashed #ddd;
    padding: 10px;
    border-radius: 4px;
    transition: border-color 0.3s;
  }
  
  .image-upload:hover {
    border-color: #007bff;
  }
  
  .image-preview {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
  }
  
  .current-image-preview {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
  }
  
  
  .preview-image {
    display: block;
    margin: 5px 0;
  }
  
  .bulk-upload-section {
    transition: all 0.3s ease;
  }
  
  .bulk-upload-section:hover {
    border-color: #0056b3 !important;
    background: #e7f3ff !important;
  }
  
  .bulk-preview-item {
    transition: transform 0.2s ease;
  }
  
  .bulk-preview-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .remove-bulk-preview {
    border-radius: 50% !important;
    width: 20px !important;
    height: 20px !important;
    padding: 0 !important;
    font-size: 12px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    line-height: 1 !important;
  }
  
  .remove-bulk-preview:hover {
    background: #c82333 !important;
    transform: scale(1.1);
  }
  
  #bulk-image-upload {
    width: 100%;
    max-width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    overflow-x: hidden;
    border-radius: 4px;
    cursor: pointer;
  }
  
  #bulk-image-upload:hover {
    border-color: #007bff;
  }
  
  #add-bulk-images {
    background: #28a745;
    border-color: #28a745;
    color: white;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  #add-bulk-images:hover {
    background: #218838;
    border-color: #218838;
    transform: translateY(-1px);
  }
  
  /* Custom Select Box Styling */
  .select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: white;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 14px;
    color: #495057;
    cursor: pointer;
    transition: all 0.3s ease;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
    min-height: 48px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }
  
  .select:hover {
    border-color: #007bff;
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.1);
    transform: translateY(-1px);
  }
  
  .select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
    transform: translateY(-1px);
  }
  
  .select option {
    padding: 8px 12px;
    color: #495057;
    background: white;
  }
  
  .select option:hover {
    background: #f8f9fa;
  }
  
  .select option:checked {
    background: #007bff;
    color: white;
  }
  
  /* Label styling for select boxes */
  .field-unit label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
    font-size: 14px;
  }
  /* Toggle switch styles */
  .toggle { position: relative; width: 48px; height: 28px; }
  .toggle-input { display: none; }
  .toggle-label {
    position: absolute; inset: 0; cursor: pointer; background: #e5e7eb;
    border-radius: 9999px; transition: background 0.25s ease;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.08);
    display: flex; align-items: center; padding: 2px;
  }
  .toggle-knob {
    width: 15px; height: 15px; background: #ffffff;
    border-radius: 50%; transition: transform 0.25s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    flex-shrink: 0;
    display: block; /* ƒê·∫£m b·∫£o hi·ªÉn th·ªã */
  }
  .toggle-input:checked + .toggle-label { background: #16a34a; }
  .toggle-input:checked + .toggle-label .toggle-knob {
    transform: translateX(28px);
  }

  /* Disabled toggle styling */
  .toggle-label.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .toggle-input:disabled + .toggle-label {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .toggle-input:disabled + .toggle-label .toggle-knob {
    background: #e5e7eb;
  }

  .toggle-input:disabled:checked + .toggle-label {
    background: #9ca3af;
  }

  /* Enhanced Button Styles */
  .btn {
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }

  .btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* Add buttons - Success colors */
  .btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    color: white;
  }

  .btn-success:hover {
    background: linear-gradient(135deg, #218838, #1ea085);
    color: white;
  }

  /* Add buttons - Info colors */
  .btn-info {
    background: linear-gradient(135deg, #17a2b8, #6f42c1);
    border: none;
    color: white;
  }

  .btn-info:hover {
    background: linear-gradient(135deg, #138496, #5a32a3);
    color: white;
  }

  /* Add buttons - Warning colors */
  .btn-warning {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
    border: none;
    color: white;
  }

  .btn-warning:hover {
    background: linear-gradient(135deg, #e0a800, #e55a00);
    color: white;
  }

  /* Add buttons - Primary colors */
  .btn-primary {
    background: linear-gradient(135deg, #007bff, #6610f2);
    border: none;
    color: white;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #0056b3, #520dc2);
    color: white;
  }

  /* Remove buttons - Outline danger */
  .btn-outline-danger {
    border: 2px solid #dc3545;
    color: #dc3545;
    background: white;
  }

  .btn-outline-danger:hover {
    background: #dc3545;
    color: white;
    border-color: #dc3545;
  }

  /* Create/Update Product Button Styling */
  .btn-create-product {
    background: linear-gradient(135deg, #007bff, #0056b3) !important;
    border: none !important;
    color: white !important;
    font-weight: 700 !important;
    font-size: 16px !important;
    padding: 12px 24px !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3) !important;
    transition: all 0.3s ease !important;
    text-transform: none !important;
    letter-spacing: 0.5px !important;
  }

  .btn-create-product:hover {
    background: linear-gradient(135deg, #0056b3, #004085) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4) !important;
    color: white !important;
  }

  .btn-create-product:active {
    transform: translateY(0) !important;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3) !important;
  }

  .btn-create-product:focus {
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25) !important;
  }

  /* Product Status Flags - Remove margin from labels */
  .status-flag-label {
    margin-bottom: 0 !important;
  }

  /* Back button styling */
  .btn-outline-secondary {
    background: white !important;
    color: #333 !important;
    border: 2px solid #6c757d !important;
    font-weight: 600;
  }

  .btn-outline-secondary:hover {
    background: #f8f9fa !important;
    color: #333 !important;
    border-color: #5a6268 !important;
  }

  /* Drag & Drop Styles */
  .sortable-container {
    min-height: 50px;
  }

  .sortable-item {
    transition: all 0.3s ease;
    background: white;
    position: relative;
  }

  .sortable-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .sortable-item.dragging {
    opacity: 0.8;
    transform: rotate(3deg) scale(1.02);
    box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    z-index: 1000;
    transition: none;
    cursor: grabbing;
  }

  .sortable-item.dragging .drag-handle {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  /* Ensure drag handle is always visible */
  .drag-handle {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: absolute !important;
    top: 10px !important;
    right: 10px !important;
    z-index: 1000 !important;
    pointer-events: auto !important;
    cursor: grab !important;
    background: none !important;
    border: none !important;
    border-radius: 0 !important;
    padding: 0 !important;
    box-shadow: none !important;
    user-select: none !important;
    color: #666 !important;
    font-size: 18px !important;
    line-height: 1 !important;
  }
  
  .drag-handle:hover {
    color: #007bff !important;
    transform: scale(1.1) !important;
    background: none !important;
  }

  .sortable-item.drag-over {
    border: 2px dashed #007bff;
    background-color: #f8f9fa;
  }

  .drag-handle {
    user-select: none;
    transition: color 0.2s ease;
    font-family: monospace;
    font-weight: bold;
    letter-spacing: 1px;
  }

  .drag-handle:hover {
    color: #007bff;
  }

  .sortable-item.dragging .drag-handle {
    cursor: grabbing;
  }

  /* Disabled Status & Flags styling */
  .status-flag-label.disabled {
    color: #6c757d !important;
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  input[type="checkbox"]:disabled + .status-flag-label.disabled {
    color: #6c757d !important;
    opacity: 0.6;
  }
  
  input[type="checkbox"]:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* Disabled checkbox container */
  .field-unit__field div:has(input[type="checkbox"]:disabled) {
    opacity: 0.7;
  }

  /* Fix overflow issues */
  .field-unit {
    max-width: 100%;
    overflow-x: hidden;
  }

  .field-unit__field {
    max-width: 100%;
    overflow-x: hidden;
  }

  /* CKEditor container */
  .cke_editor {
    max-width: 100% !important;
    overflow-x: hidden !important;
  }

  /* Image preview containers */
  .image-preview {
    max-width: 100%;
    overflow-x: hidden;
  }

  .preview-image {
    max-width: 100% !important;
    height: auto !important;
  }

  /* Bulk upload preview */
  .bulk-preview-item {
    max-width: 100%;
    overflow-x: hidden;
  }

  .bulk-preview-item img {
    max-width: 100% !important;
    height: auto !important;
  }

  /* Form containers */
  .nested-form {
    max-width: 100%;
    overflow-x: hidden;
  }

  /* Grid layouts */
  .field-unit__field[style*="grid"] {
    max-width: 100%;
    overflow-x: hidden;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .field-unit__field[style*="grid-template-columns"] {
      grid-template-columns: 1fr !important;
    }
  }
</style>

<script>
  (function(){
    const input = document.getElementById('product_is_active');
    const label = document.getElementById('active-label');
    function syncLabel(){
      if (!input || !label) return;
      // Default to false (unchecked) for new products
      const isChecked = input.checked;
      label.textContent = isChecked ? 'Hi·ªÉn th·ªã s·∫£n ph·∫©m tr√™n website' : '·∫®n s·∫£n ph·∫©m kh·ªèi website';
      label.style.color = isChecked ? '#065f46' : '#6b7280';
    }
    document.addEventListener('turbo:load', syncLabel);
    document.addEventListener('DOMContentLoaded', syncLabel);
    if (input) input.addEventListener('change', syncLabel);
    
    // Ensure default state is false for new products
    if (input && !input.hasAttribute('value')) {
      input.checked = false;
    }
  })();
</script>

<script>
  // Override page title
  document.addEventListener('DOMContentLoaded', function() {
    const titleElement = document.querySelector('h1');
    if (titleElement && titleElement.textContent.includes('M·ªõi S·∫£n Ph·∫©m')) {
      titleElement.textContent = 'T·∫°o S·∫£n Ph·∫©m M·ªõi';
    }
  });

  // Video active toggle functionality
  function initializeVideoToggles() {
    const videoToggles = document.querySelectorAll('input[id^="video_is_active_"]');
    videoToggles.forEach(function(toggle) {
      const labelId = 'video-active-label-' + toggle.id.split('_').pop();
      const label = document.getElementById(labelId);

      if (label) {
        function updateLabel() {
          if (toggle.checked) {
            label.textContent = 'Video ƒëang ho·∫°t ƒë·ªông';
            label.style.color = '#065f46';
          } else {
            label.textContent = 'Video ƒë√£ t·∫Øt';
            label.style.color = '#6b7280';
          }
        }

        toggle.addEventListener('change', updateLabel);
        updateLabel(); // Set initial state
      }
    });
  }

  // Initialize video toggles on page load and when new videos are added
  document.addEventListener('DOMContentLoaded', initializeVideoToggles);
  document.addEventListener('turbo:load', initializeVideoToggles);
</script>