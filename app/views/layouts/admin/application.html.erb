<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1">
  <title>
    <%= content_for(:title) %>
    <%= Rails.application.class.name.split("::").first.titleize %> Admin
  </title>

  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <%= stylesheet_link_tag "administrate/application" %>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="//cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
  <%= javascript_importmap_tags %>
  <%= javascript_include_tag "administrate/application" %>
  <%= javascript_include_tag "admin/nested_forms" %>
  
  <!-- Load jQuery and Select2 at the end to avoid conflicts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    // Ensure jQuery is available globally
    window.jQuery = window.$ = jQuery;
    console.log('jQuery loaded:', typeof $ !== 'undefined');
    console.log('jQuery version:', $.fn.jquery);
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    console.log('Select2 loaded:', typeof $.fn.select2 !== 'undefined');
    if (typeof $.fn.select2 !== 'undefined') {
      console.log('Select2 is ready to use');
    }
    
    // Override selectize to prevent errors from administrate
    if (typeof $.fn.selectize === 'undefined') {
      $.fn.selectize = function() {
        console.log('selectize called but not available, using select2 instead');
        return this;
      };
    }
  </script>
  
  <style>
    .admin-layout {
      display: flex;
      min-height: 100vh;
    }
    
    /* Custom Select2 styling for admin forms */
    .select2-container {
      width: 100% !important;
      z-index: 9999;
    }
    
    .select2-container--default .select2-selection--single {
      height: 40px !important;
      border: 1px solid #d1d5db !important;
      border-radius: 6px !important;
      padding: 0 !important;
      background: white !important;
      transition: all 0.2s ease !important;
    }
    
    .select2-container--default .select2-selection--single:hover {
      border-color: #9ca3af !important;
    }
    
    .select2-container--default.select2-container--focus .select2-selection--single {
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
      outline: none !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 38px !important;
      padding-left: 12px !important;
      padding-right: 40px !important;
      color: #374151 !important;
      font-size: 14px !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__placeholder {
      color: #9ca3af !important;
      font-style: normal !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 38px !important;
      right: 12px !important;
      width: 20px !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow b {
      border-color: #6b7280 transparent transparent transparent !important;
      border-style: solid !important;
      border-width: 5px 4px 0 4px !important;
      height: 0 !important;
      left: 50% !important;
      margin-left: -4px !important;
      margin-top: -2px !important;
      position: absolute !important;
      top: 50% !important;
      width: 0 !important;
    }
    
    .select2-dropdown {
      border: 1px solid #d1d5db !important;
      border-radius: 6px !important;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
      background: white !important;
      z-index: 9999 !important;
    }
    
    .select2-search--dropdown .select2-search__field {
      border: 1px solid #d1d5db !important;
      border-radius: 4px !important;
      padding: 8px 12px !important;
      font-size: 14px !important;
      outline: none !important;
    }
    
    .select2-search--dropdown .select2-search__field:focus {
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }
    
    .select2-results__option {
      padding: 10px 12px !important;
      font-size: 14px !important;
      color: #374151 !important;
      transition: background-color 0.2s ease !important;
    }
    
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
      background-color: #3b82f6 !important;
      color: white !important;
    }
    
    .select2-container--default .select2-results__option[aria-selected=true] {
      background-color: #f3f4f6 !important;
      color: #374151 !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__clear {
      color: #9ca3af !important;
      font-size: 16px !important;
      line-height: 1 !important;
      padding: 0 6px !important;
      right: 35px !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      position: absolute !important;
      z-index: 10 !important;
      cursor: pointer !important;
      border-radius: 50% !important;
      width: 20px !important;
      height: 20px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      background: rgba(255, 255, 255, 0.8) !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__clear:hover {
      color: #ef4444 !important;
      background: rgba(239, 68, 68, 0.1) !important;
    }
    
    /* Ensure clear button is properly positioned */
    .select2-container--default .select2-selection--single {
      position: relative !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      padding-right: 60px !important; /* Make room for both clear and arrow */
    }
    
    /* Adjust arrow position to avoid overlap with clear button */
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      right: 12px !important;
    }
    
    /* Remove scrollbars */
    .select2-results {
      max-height: 200px !important;
      overflow-y: auto !important;
    }
    
    .select2-results::-webkit-scrollbar {
      width: 6px !important;
    }
    
    .select2-results::-webkit-scrollbar-track {
      background: #f1f5f9 !important;
      border-radius: 3px !important;
    }
    
    .select2-results::-webkit-scrollbar-thumb {
      background: #cbd5e1 !important;
      border-radius: 3px !important;
    }
    
    .select2-results::-webkit-scrollbar-thumb:hover {
      background: #94a3b8 !important;
    }
    
    /* Hide scrollbar for Firefox */
    .select2-results {
      scrollbar-width: thin !important;
      scrollbar-color: #cbd5e1 #f1f5f9 !important;
    }
    
    .admin-sidebar {
      width: 250px;
      background: #343a40;
      color: white;
      padding: 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    
    .admin-content {
      flex: 1;
      margin-left: 250px;
      padding: 20px;
      background: #f8f9fa;
      min-height: 100vh;
    }
    
    .sidebar-header {
      padding: 20px;
      background: #212529;
      border-bottom: 1px solid #495057;
    }
    
    .sidebar-header h3 {
      margin: 0;
      color: white;
      font-size: 18px;
    }
    
    .sidebar-nav {
      padding: 0;
      margin: 0;
      list-style: none;
    }
    
    .sidebar-nav li {
      border-bottom: 1px solid #495057;
    }
    
    .sidebar-nav a {
      display: block;
      padding: 15px 20px;
      color: #adb5bd;
      text-decoration: none;
      transition: all 0.3s;
    }
    
    .sidebar-nav a:hover,
    .sidebar-nav a.active {
      background: #495057;
      color: white;
    }
    
    .sidebar-nav a.logout-link {
      color: #dc3545 !important;
    }
    
    .sidebar-nav a.logout-link:hover {
      background: #dc3545 !important;
      color: white !important;
    }
    
    .sidebar-nav .nav-icon {
      width: 20px;
      display: inline-block;
      margin-right: 10px;
    }
    
    .content-header {
      background: white;
      padding: 20px;
      margin: -20px -20px 20px -20px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .content-header h1 {
      margin: 0;
      color: #495057;
    }
    
    .main-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    @media (max-width: 768px) {
      .admin-sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }
      
      .admin-content {
        margin-left: 0;
      }
      
      .sidebar-toggle {
        display: block !important;
      }
      
      .admin-sidebar.open {
        transform: translateX(0);
      }
    }
    
    .sidebar-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: #343a40;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
    }
    
    .alert {
      margin-bottom: 20px;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid transparent;
    }
    
    .alert-success {
      background-color: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }
    
    .alert-danger {
      background-color: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    
    .alert-info {
      background-color: #d1ecf1;
      border-color: #bee5eb;
      color: #0c5460;
    }
    
    .alert-warning {
      background-color: #fff3cd;
      border-color: #ffeaa7;
      color: #856404;
    }
  </style>
</head>

<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <nav class="admin-sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3>Admin Panel</h3>
        <% if current_admin_user %>
          <div style="margin-top: 10px; font-size: 12px; color: #adb5bd;">
            <div>👤 <%= current_admin_user.email %></div>
            <% if current_admin_user.respond_to?(:super_admin?) && current_admin_user.super_admin? %>
              <div style="color: #28a745; font-weight: bold;">SUPER ADMIN</div>
            <% end %>
          </div>
        <% end %>
      </div>
      
      <ul class="sidebar-nav">
        <li>
          <%= link_to admin_root_path, class: "#{current_page?(admin_root_path) ? 'active' : ''}" do %>
            <span class="nav-icon">📊</span>
            Dashboard
          <% end %>
        </li>
        
        <li>
          <%= link_to admin_products_path, class: "#{current_page?(admin_products_path) || request.path.start_with?('/admin/products') ? 'active' : ''}" do %>
            <span class="nav-icon">📦</span>
            Products
          <% end %>
        </li>
        
        <li>
          <%= link_to admin_brands_path, class: "#{current_page?(admin_brands_path) || request.path.start_with?('/admin/brands') ? 'active' : ''}" do %>
            <span class="nav-icon">🏷️</span>
            Brands
          <% end %>
        </li>
        
        <li>
          <%= link_to admin_categories_path, class: "#{current_page?(admin_categories_path) || request.path.start_with?('/admin/categories') ? 'active' : ''}" do %>
            <span class="nav-icon">📂</span>
            Categories
          <% end %>
        </li>
        
        <% if current_admin_user&.super_admin? %>
          <li>
            <%= link_to admin_admin_users_path, class: "#{current_page?(admin_admin_users_path) || request.path.start_with?('/admin/admin_users') ? 'active' : ''}" do %>
              <span class="nav-icon">👥</span>
              Users
            <% end %>
          </li>
        <% end %>
        
        <li>
          <%= link_to admin_orders_path, class: "#{current_page?(admin_orders_path) || request.path.start_with?('/admin/orders') ? 'active' : ''}" do %>
            <span class="nav-icon">📈</span>
            Orders
          <% end %>
        </li>
        
        <% if current_admin_user&.client? %>
          <li>
            <%= link_to admin_notifications_path, class: "#{current_page?(admin_notifications_path) || request.path.start_with?('/admin/notifications') ? 'active' : ''}" do %>
              <span class="nav-icon">🔔</span>
              Thông báo
              <% if current_admin_user.client_notifications.unread.count > 0 %>
                <span style="background: #dc3545; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; margin-left: 5px;">
                  <%= current_admin_user.client_notifications.unread.count %>
                </span>
              <% end %>
            <% end %>
          </li>
        <% end %>
        
        
        <li style="border-top: 1px solid #495057;">
          <%= link_to destroy_admin_user_session_path, method: :delete, 
              data: { confirm: 'Bạn có chắc chắn muốn đăng xuất?' },
              class: "logout-link" do %>
            <span class="nav-icon">🚪</span>
            Đăng xuất
          <% end %>
        </li>
      </ul>
    </nav>
    
    <!-- Main Content -->
    <main class="admin-content">
      <button class="sidebar-toggle" onclick="toggleSidebar()">☰</button>
      
      <!-- Flash Messages -->
      <% if notice %>
        <div class="alert alert-success">
          <%= notice %>
        </div>
      <% end %>
      
      <% if alert %>
        <div class="alert alert-danger">
          <%= alert %>
        </div>
      <% end %>
      
      <%= content_for(:layout) %>
    </main>
  </div>

  <script type="text/javascript">
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }
    
    // Wait for both CKEDITOR and DOM to be ready
    var initializeCKEditorWhenReady = function() {
      if (typeof CKEDITOR !== 'undefined' && document.readyState === 'complete') {
        setTimeout(function() {
          var textareas = document.querySelectorAll('textarea.ckeditor');
          textareas.forEach(function(textarea) {
            if (!CKEDITOR.instances[textarea.id]) {
              CKEDITOR.replace(textarea.id, {
                height: 400,
                language: 'vi',
                toolbar: [
                  { name: 'document', items: [ 'Source', '-', 'NewPage', 'Preview', '-', 'Templates' ] },
                  { name: 'clipboard', items: [ 'Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo' ] },
                  { name: 'editing', items: [ 'Find', 'Replace', '-', 'SelectAll' ] },
                  '/',
                  { name: 'basicstyles', items: [ 'Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'RemoveFormat' ] },
                  { name: 'paragraph', items: [ 'NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote', 'CreateDiv', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock' ] },
                  { name: 'links', items: [ 'Link', 'Unlink', 'Anchor' ] },
                  '/',
                  { name: 'insert', items: [ 'Image', 'Table', 'HorizontalRule', 'SpecialChar' ] },
                  { name: 'styles', items: [ 'Styles', 'Format', 'Font', 'FontSize' ] },
                  { name: 'colors', items: [ 'TextColor', 'BGColor' ] },
                  { name: 'tools', items: [ 'Maximize' ] }
                ],
                filebrowserBrowseUrl: '/ckeditor/attachment_files',
                filebrowserImageBrowseUrl: '/ckeditor/pictures',
                filebrowserImageUploadUrl: '/ckeditor/pictures',
                filebrowserUploadUrl: '/ckeditor/attachment_files'
              });
            }
          });
        }, 100);
      } else {
        setTimeout(initializeCKEditorWhenReady, 100);
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      initializeCKEditorWhenReady();
      
      // Fix back button styling to match "Back to Products"
      const backButtons = document.querySelectorAll('a.btn-primary');
      backButtons.forEach(button => {
        if (button.textContent.includes('Trở lại') || button.textContent.includes('Back')) {
          button.classList.remove('btn-primary');
          button.classList.add('btn-secondary');
        }
      });
    });
  </script>

  <!-- Global Button Hover Fix -->
  <style>
    /* Fix button hover text color issues across all admin pages */
    .btn:hover {
      color: white !important;
    }

    .btn-primary:hover {
      background: #0056b3 !important;
      border-color: #0056b3 !important;
      color: white !important;
    }

    .btn-secondary:hover {
      background: #545b62 !important;
      border-color: #545b62 !important;
      color: white !important;
    }

    .btn-success:hover {
      background: #1e7e34 !important;
      border-color: #1e7e34 !important;
      color: white !important;
    }

    .btn-danger:hover {
      background: #bd2130 !important;
      border-color: #bd2130 !important;
      color: white !important;
    }

    .btn-warning:hover {
      background: #e0a800 !important;
      border-color: #e0a800 !important;
      color: #212529 !important;
    }

    .btn-info:hover {
      background: #117a8b !important;
      border-color: #117a8b !important;
      color: white !important;
    }

    .btn-outline-primary:hover {
      background: #007bff !important;
      border-color: #007bff !important;
      color: white !important;
    }

    .btn-outline-secondary:hover {
      background: #6c757d !important;
      border-color: #6c757d !important;
      color: white !important;
    }

    .btn-outline-success:hover {
      background: #28a745 !important;
      border-color: #28a745 !important;
      color: white !important;
    }

    .btn-outline-danger:hover {
      background: #dc3545 !important;
      border-color: #dc3545 !important;
      color: white !important;
    }

    .btn-outline-warning:hover {
      background: #ffc107 !important;
      border-color: #ffc107 !important;
      color: #212529 !important;
    }

    .btn-outline-info:hover {
      background: #17a2b8 !important;
      border-color: #17a2b8 !important;
      color: white !important;
    }

    /* Fix back button styling to match "Back to Products" */
    .btn-primary[href*="admin_products_path"],
    .btn-primary[href*="admin_products"] {
      background: #6c757d !important;
      border-color: #6c757d !important;
      color: white !important;
    }

    .btn-primary[href*="admin_products_path"]:hover,
    .btn-primary[href*="admin_products"]:hover {
      background: #545b62 !important;
      border-color: #545b62 !important;
      color: white !important;
    }

    /* Hide CKEditor security warning banner */
    .cke_notifications_area {
      display: none !important;
    }

    .cke_notification {
      display: none !important;
    }

    .cke_notification_info {
      display: none !important;
    }

    .cke_notification_warning {
      display: none !important;
    }

    .cke_notification_error {
      display: none !important;
    }

    /* Hide any CKEditor version warning */
    div[style*="background-color: red"],
    div[style*="background: red"],
    .cke_warning,
    .cke_security_warning {
      display: none !important;
    }

    /* Error styling for form validation - maintain layout */
    .field_with_errors {
      display: block;
      width: 100%;
    }

    .field_with_errors input,
    .field_with_errors textarea,
    .field_with_errors select {
      border: 2px solid #dc3545 !important;
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
      width: 100% !important;
      min-width: 100% !important;
      max-width: 100% !important;
      display: block !important;
      box-sizing: border-box !important;
    }

    .field_with_errors input:focus,
    .field_with_errors textarea:focus,
    .field_with_errors select:focus {
      border-color: #dc3545 !important;
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
      outline: none !important;
    }

    /* Ensure field-unit maintains proper layout */
    .field-unit {
      display: block;
      width: 100%;
      margin-bottom: 20px;
    }

    .field-unit__label {
      display: block;
      margin-bottom: 8px;
    }

    .field-unit__field {
      display: block;
      width: 100%;
    }

    /* Ensure text-field maintains full width */
    .text-field {
      width: 100% !important;
      display: block !important;
      box-sizing: border-box !important;
    }

    /* Error message styling */
    .error-message {
      color: #dc3545;
      font-size: 12px;
      margin-top: 4px;
      display: block;
      font-weight: 500;
    }

    .error-message::before {
      content: "⚠️ ";
      margin-right: 4px;
    }

    /* Hide default error messages */
    .alert-danger {
      display: none !important;
    }
  </style>

  <script>
    // Simple CKEditor warning hide
    setTimeout(function() {
      var elements = document.querySelectorAll('.cke_notifications_area, .cke_notification, .cke_notification_warning, .cke_security_warning');
      for (var i = 0; i < elements.length; i++) {
        elements[i].style.display = 'none';
      }
    }, 500);

    // Error display handling
    document.addEventListener('DOMContentLoaded', function() {
      // Hide default error messages
      var defaultErrors = document.querySelectorAll('.alert-danger');
      for (var i = 0; i < defaultErrors.length; i++) {
        defaultErrors[i].style.display = 'none';
      }

      // Add error messages to field_with_errors
      var fieldErrors = document.querySelectorAll('.field_with_errors');
      for (var i = 0; i < fieldErrors.length; i++) {
        var fieldError = fieldErrors[i];
        var input = fieldError.querySelector('input, textarea, select');
        if (input) {
          var fieldUnit = input.closest('.field-unit') || fieldError;
          var existingError = fieldUnit.querySelector('.error-message');
          if (!existingError) {
            var errorText = getFieldErrorText(input.name);
            if (errorText) {
              var errorDiv = document.createElement('div');
              errorDiv.className = 'error-message';
              errorDiv.textContent = errorText;
              fieldUnit.appendChild(errorDiv);
            }
          }
        }
      }

      // Clear errors when user starts typing
      var inputs = document.querySelectorAll('input, textarea, select');
      for (var i = 0; i < inputs.length; i++) {
        inputs[i].addEventListener('input', function() {
          var fieldUnit = this.closest('.field-unit');
          if (fieldUnit && fieldUnit.classList.contains('field_with_errors')) {
            fieldUnit.classList.remove('field_with_errors');
            var errorMessage = fieldUnit.querySelector('.error-message');
            if (errorMessage) {
              errorMessage.remove();
            }
          }
        });
      }
    });

    function getFieldErrorText(fieldName) {
      var errorMessages = {
        'product[name]': 'Tên sản phẩm không được để trống',
        'product[sku]': 'SKU không được để trống',
        'product[price]': 'Giá sản phẩm không được để trống',
        'product[brand_id]': 'Thương hiệu không được để trống',
        'product[category_id]': 'Danh mục không được để trống',
        'product[short_description]': 'Mô tả ngắn không được để trống'
      };
      return errorMessages[fieldName] || 'Trường này không hợp lệ';
    }
  </script>
</body>
</html>