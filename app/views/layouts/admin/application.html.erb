<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1">
  <title>
    <%= content_for(:title) %>
    <%= Rails.application.class.name.split("::").first.titleize %> Admin
  </title>

  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <%= stylesheet_link_tag "administrate/application" %>
  <script src="//cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
  <%= javascript_importmap_tags %>
  <%= javascript_include_tag "administrate/application" %>
  <%= javascript_include_tag "admin/nested_forms" %>
  
  <style>
    .admin-layout {
      display: flex;
      min-height: 100vh;
    }
    
    .admin-sidebar {
      width: 250px;
      background: #343a40;
      color: white;
      padding: 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    
    .admin-content {
      flex: 1;
      margin-left: 250px;
      padding: 20px;
      background: #f8f9fa;
      min-height: 100vh;
    }
    
    .sidebar-header {
      padding: 20px;
      background: #212529;
      border-bottom: 1px solid #495057;
    }
    
    .sidebar-header h3 {
      margin: 0;
      color: white;
      font-size: 18px;
    }
    
    .sidebar-nav {
      padding: 0;
      margin: 0;
      list-style: none;
    }
    
    .sidebar-nav li {
      border-bottom: 1px solid #495057;
    }
    
    .sidebar-nav a {
      display: block;
      padding: 15px 20px;
      color: #adb5bd;
      text-decoration: none;
      transition: all 0.3s;
    }
    
    .sidebar-nav a:hover,
    .sidebar-nav a.active {
      background: #495057;
      color: white;
    }
    
    .sidebar-nav a.logout-link {
      color: #dc3545 !important;
    }
    
    .sidebar-nav a.logout-link:hover {
      background: #dc3545 !important;
      color: white !important;
    }
    
    .sidebar-nav .nav-icon {
      width: 20px;
      display: inline-block;
      margin-right: 10px;
    }
    
    .content-header {
      background: white;
      padding: 20px;
      margin: -20px -20px 20px -20px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .content-header h1 {
      margin: 0;
      color: #495057;
    }
    
    .main-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    @media (max-width: 768px) {
      .admin-sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }
      
      .admin-content {
        margin-left: 0;
      }
      
      .sidebar-toggle {
        display: block !important;
      }
      
      .admin-sidebar.open {
        transform: translateX(0);
      }
    }
    
    .sidebar-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: #343a40;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
    }
    
    .alert {
      margin-bottom: 20px;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid transparent;
    }
    
    .alert-success {
      background-color: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }
    
    .alert-danger {
      background-color: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    
    .alert-info {
      background-color: #d1ecf1;
      border-color: #bee5eb;
      color: #0c5460;
    }
    
    .alert-warning {
      background-color: #fff3cd;
      border-color: #ffeaa7;
      color: #856404;
    }
  </style>
</head>

<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <nav class="admin-sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3>Admin Panel</h3>
        <% if current_admin_user %>
          <div style="margin-top: 10px; font-size: 12px; color: #adb5bd;">
            <div>üë§ <%= current_admin_user.email %></div>
            <% if current_admin_user.respond_to?(:super_admin?) && current_admin_user.super_admin? %>
              <div style="color: #28a745; font-weight: bold;">SUPER ADMIN</div>
            <% end %>
          </div>
        <% end %>
      </div>
      
      <ul class="sidebar-nav">
        <li>
          <%= link_to admin_root_path, class: "#{current_page?(admin_root_path) ? 'active' : ''}" do %>
            <span class="nav-icon">üìä</span>
            Dashboard
          <% end %>
        </li>
        
        <li>
          <%= link_to admin_products_path, class: "#{current_page?(admin_products_path) || request.path.start_with?('/admin/products') ? 'active' : ''}" do %>
            <span class="nav-icon">üì¶</span>
            Products
          <% end %>
        </li>
        
        <li>
          <%= link_to admin_brands_path, class: "#{current_page?(admin_brands_path) || request.path.start_with?('/admin/brands') ? 'active' : ''}" do %>
            <span class="nav-icon">üè∑Ô∏è</span>
            Brands
          <% end %>
        </li>
        
        <li>
          <%= link_to admin_categories_path, class: "#{current_page?(admin_categories_path) || request.path.start_with?('/admin/categories') ? 'active' : ''}" do %>
            <span class="nav-icon">üìÇ</span>
            Categories
          <% end %>
        </li>
        
        <li>
          <a href="#">
            <span class="nav-icon">üë•</span>
            Users
          </a>
        </li>
        
        <li>
          <%= link_to admin_orders_path, class: "#{current_page?(admin_orders_path) || request.path.start_with?('/admin/orders') ? 'active' : ''}" do %>
            <span class="nav-icon">üìà</span>
            Orders
          <% end %>
        </li>
        
        <% if current_admin_user&.client? %>
          <li>
            <%= link_to admin_notifications_path, class: "#{current_page?(admin_notifications_path) || request.path.start_with?('/admin/notifications') ? 'active' : ''}" do %>
              <span class="nav-icon">üîî</span>
              Th√¥ng b√°o
              <% if current_admin_user.client_notifications.unread.count > 0 %>
                <span style="background: #dc3545; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; margin-left: 5px;">
                  <%= current_admin_user.client_notifications.unread.count %>
                </span>
              <% end %>
            <% end %>
          </li>
        <% end %>
        
        <li>
          <a href="#">
            <span class="nav-icon">‚öôÔ∏è</span>
            Settings
          </a>
        </li>
        
        <li style="border-top: 1px solid #495057;">
          <a href="/" target="_blank">
            <span class="nav-icon">üåê</span>
            View Site
          </a>
        </li>
        
        <li style="border-top: 1px solid #495057;">
          <%= link_to destroy_admin_user_session_path, method: :delete, 
              data: { confirm: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?' },
              class: "logout-link" do %>
            <span class="nav-icon">üö™</span>
            ƒêƒÉng xu·∫•t
          <% end %>
        </li>
      </ul>
    </nav>
    
    <!-- Main Content -->
    <main class="admin-content">
      <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
      
      <!-- Flash Messages -->
      <% if notice %>
        <div class="alert alert-success">
          <%= notice %>
        </div>
      <% end %>
      
      <% if alert %>
        <div class="alert alert-danger">
          <%= alert %>
        </div>
      <% end %>
      
      <%= content_for(:layout) %>
    </main>
  </div>

  <script type="text/javascript">
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }
    
    // Wait for both CKEDITOR and DOM to be ready
    var initializeCKEditorWhenReady = function() {
      if (typeof CKEDITOR !== 'undefined' && document.readyState === 'complete') {
        console.log('CKEDITOR is ready, initializing...');
        setTimeout(function() {
          var textareas = document.querySelectorAll('textarea.ckeditor');
          console.log('Found textareas:', textareas.length);
          textareas.forEach(function(textarea) {
            if (!CKEDITOR.instances[textarea.id]) {
              console.log('Initializing CKEditor for:', textarea.id);
              CKEDITOR.replace(textarea.id, {
                height: 400,
                language: 'vi',
                toolbar: [
                  { name: 'document', items: [ 'Source', '-', 'NewPage', 'Preview', '-', 'Templates' ] },
                  { name: 'clipboard', items: [ 'Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo' ] },
                  { name: 'editing', items: [ 'Find', 'Replace', '-', 'SelectAll' ] },
                  '/',
                  { name: 'basicstyles', items: [ 'Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'RemoveFormat' ] },
                  { name: 'paragraph', items: [ 'NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote', 'CreateDiv', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock' ] },
                  { name: 'links', items: [ 'Link', 'Unlink', 'Anchor' ] },
                  '/',
                  { name: 'insert', items: [ 'Image', 'Table', 'HorizontalRule', 'SpecialChar' ] },
                  { name: 'styles', items: [ 'Styles', 'Format', 'Font', 'FontSize' ] },
                  { name: 'colors', items: [ 'TextColor', 'BGColor' ] },
                  { name: 'tools', items: [ 'Maximize' ] }
                ],
                filebrowserBrowseUrl: '/ckeditor/attachment_files',
                filebrowserImageBrowseUrl: '/ckeditor/pictures',
                filebrowserImageUploadUrl: '/ckeditor/pictures',
                filebrowserUploadUrl: '/ckeditor/attachment_files'
              });
            }
          });
        }, 100);
      } else {
        setTimeout(initializeCKEditorWhenReady, 100);
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      initializeCKEditorWhenReady();
      
      // Fix back button styling to match "Back to Products"
      const backButtons = document.querySelectorAll('a.btn-primary');
      backButtons.forEach(button => {
        if (button.textContent.includes('Tr·ªü l·∫°i') || button.textContent.includes('Back')) {
          button.classList.remove('btn-primary');
          button.classList.add('btn-secondary');
        }
      });
    });
  </script>

  <!-- Global Button Hover Fix -->
  <style>
    /* Fix button hover text color issues across all admin pages */
    .btn:hover {
      color: white !important;
    }

    .btn-primary:hover {
      background: #0056b3 !important;
      border-color: #0056b3 !important;
      color: white !important;
    }

    .btn-secondary:hover {
      background: #545b62 !important;
      border-color: #545b62 !important;
      color: white !important;
    }

    .btn-success:hover {
      background: #1e7e34 !important;
      border-color: #1e7e34 !important;
      color: white !important;
    }

    .btn-danger:hover {
      background: #bd2130 !important;
      border-color: #bd2130 !important;
      color: white !important;
    }

    .btn-warning:hover {
      background: #e0a800 !important;
      border-color: #e0a800 !important;
      color: #212529 !important;
    }

    .btn-info:hover {
      background: #117a8b !important;
      border-color: #117a8b !important;
      color: white !important;
    }

    .btn-outline-primary:hover {
      background: #007bff !important;
      border-color: #007bff !important;
      color: white !important;
    }

    .btn-outline-secondary:hover {
      background: #6c757d !important;
      border-color: #6c757d !important;
      color: white !important;
    }

    .btn-outline-success:hover {
      background: #28a745 !important;
      border-color: #28a745 !important;
      color: white !important;
    }

    .btn-outline-danger:hover {
      background: #dc3545 !important;
      border-color: #dc3545 !important;
      color: white !important;
    }

    .btn-outline-warning:hover {
      background: #ffc107 !important;
      border-color: #ffc107 !important;
      color: #212529 !important;
    }

    .btn-outline-info:hover {
      background: #17a2b8 !important;
      border-color: #17a2b8 !important;
      color: white !important;
    }

    /* Fix back button styling to match "Back to Products" */
    .btn-primary[href*="admin_products_path"],
    .btn-primary[href*="admin_products"] {
      background: #6c757d !important;
      border-color: #6c757d !important;
      color: white !important;
    }

    .btn-primary[href*="admin_products_path"]:hover,
    .btn-primary[href*="admin_products"]:hover {
      background: #545b62 !important;
      border-color: #545b62 !important;
      color: white !important;
    }
  </style>
</body>
</html>